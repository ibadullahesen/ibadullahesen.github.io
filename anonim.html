<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Google iÃ§in kritik SEO Meta Tag'leri -->
    <title>AxtarGet Chat - Pulsuz Online Chat PlatformasÄ± | AzÉ™rbaycan Chat SaytÄ±</title>
    <meta name="description" content="AxtarGet ilÉ™ pulsuz online chat edin. Yeni insanlarla tanÄ±ÅŸ olun, sÃ¶hbÉ™t edin. HeÃ§ bir qeydiyyat yoxdur, dÉ™rhal baÅŸlayÄ±n. AzÉ™rbaycanda É™n yaxÅŸÄ± chat platformasÄ±.">
    <meta name="keywords" content="pulsuz chat, online chat, AzÉ™rbaycan chat, yeni insanlarla tanÄ±ÅŸ olmaq, dost axtarmaq, virtual tanÄ±ÅŸlÄ±q, sÃ¶hbÉ™t etmÉ™k, random chat, chat otaÄŸÄ±, online sÃ¶hbÉ™t">
    <meta name="author" content="AxtarGet Chat">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <meta name="language" content="Azerbaijani">
    <meta name="geo.region" content="AZ">
    <meta name="geo.placename" content="Baku">
    <meta name="geo.position" content="40.409264;49.867092">
    <meta name="ICBM" content="40.409264, 49.867092">
    
    <!-- Mobil Optimizasyon -->
    <meta name="format-detection" content="telephone=no">
    <meta name="HandheldFriendly" content="true">
    <meta name="MobileOptimized" content="width">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <!-- Site DoÄŸrulama (Google Search Console iÃ§in) -->
    <!-- <meta name="google-site-verification" content="GOOGLE_SITE_VERIFICATION_KODUNUZ"> -->
    
    <!-- Canonical & Alternatif URL'ler -->
    <link rel="canonical" href="https://axtarget.com/">
    <link rel="alternate" hreflang="az" href="https://axtarget.com/">
    <link rel="alternate" hreflang="az-AZ" href="https://axtarget.com/">
    <link rel="alternate" hreflang="x-default" href="https://axtarget.com/">
    
    <!-- HÄ±z Optimizasyonu -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    
    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    
    <!-- JSON-LD Structured Data (Google iÃ§in kritik!) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "AxtarGet Chat PlatformasÄ±",
        "alternateName": "AxtarGet Online Chat",
        "url": "https://axtarget.com/",
        "description": "AzÉ™rbaycanda É™n yaxÅŸÄ± pulsuz online chat platformasÄ±. Yeni insanlarla tanÄ±ÅŸ olun, sÃ¶hbÉ™t edin.",
        "publisher": {
            "@type": "Organization",
            "name": "AxtarGet",
            "url": "https://axtarget.com/",
            "logo": {
                "@type": "ImageObject",
                "url": "https://axtarget.com/logo.png",
                "width": 200,
                "height": 60
            }
        },
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://axtarget.com/?q={search_term_string}",
            "query-input": "required name=search_term_string"
        },
        "inLanguage": "az-AZ",
        "keywords": "pulsuz chat, online chat, AzÉ™rbaycan chat, tanÄ±ÅŸlÄ±q, sÃ¶hbÉ™t",
        "isAccessibleForFree": true
    }
    </script>
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "AxtarGet Chat",
        "applicationCategory": "CommunicationApplication",
        "operatingSystem": "Any",
        "description": "Pulsuz online chat vÉ™ tanÄ±ÅŸlÄ±q platformasÄ±",
        "url": "https://axtarget.com/",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "author": {
            "@type": "Organization",
            "name": "AxtarGet"
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "1500",
            "bestRating": "5",
            "worstRating": "1"
        },
        "review": {
            "@type": "Review",
            "reviewRating": {
                "@type": "Rating",
                "ratingValue": "5",
                "bestRating": "5"
            },
            "author": {
                "@type": "Person",
                "name": "Mehmet Æli"
            },
            "reviewBody": "Æn yaxÅŸÄ± chat platformasÄ±! Tez qoÅŸulursan vÉ™ yeni dostlar tapÄ±rsan."
        }
    }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0f172a',
                        'primary-light': '#1e293b',
                        'accent': '#06b6d4',
                        'accent-dark': '#0891b2',
                        'error': '#ef4444',
                        'success': '#10b981',
                        'warning': '#f59e0b'
                    },
                    fontFamily: {
                        sans: ['"Inter"', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', system-ui, sans-serif; }
        
        .gradient-text {
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card-shadow {
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(6, 182, 212, 0.3);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .message-bubble {
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .modal-overlay {
            backdrop-filter: blur(4px);
            background-color: rgba(15, 23, 42, 0.85);
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #06b6d4;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1), 0 0 0 2px #06b6d4;
        }
        
        .status-online {
            color: #10b981;
        }
        
        .status-typing {
            color: #f59e0b;
        }
        
        /* SEO iÃ§in optimized hidden content */
        .seo-content {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Typing indicator styles */
        .typing-dots {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #f59e0b;
            border-radius: 50%;
            animation: typing-dot 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing-dot {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.6;
            }
            30% {
                transform: translateY(-4px);
                opacity: 1;
            }
        }
        
        /* WhatsApp balonu Ã¼Ã§Ã¼n Ã¼slublar */
        .whatsapp-ballon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #25D366;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(37, 211, 102, 0.4);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: float 3s ease-in-out infinite;
        }
        
        .whatsapp-ballon:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(37, 211, 102, 0.6);
        }
        
        .whatsapp-ballon svg {
            width: 32px;
            height: 32px;
            fill: white;
        }
        
        @keyframes float {
            0% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
            100% {
                transform: translateY(0px);
            }
        }
        
        /* WhatsApp tooltip */
        .whatsapp-tooltip {
            position: absolute;
            right: 70px;
            bottom: 15px;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            border: 1px solid #1e293b;
        }
        
        .whatsapp-ballon:hover .whatsapp-tooltip {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-primary text-white min-h-screen">
    <!-- Google iÃ§in SEO Content (Hidden) -->
    <div class="seo-content">
        <h1>AxtarGet Chat - AzÉ™rbaycanda É™n yaxÅŸÄ± pulsuz online chat platformasÄ±</h1>
        <h2>Yeni insanlarla tanÄ±ÅŸ olmaq Ã¼Ã§Ã¼n É™n asan yol</h2>
        <p>AxtarGet pulsuz online chat platformasÄ± ilÉ™ yeni dostlar tapÄ±n, sÃ¶hbÉ™t edin, tanÄ±ÅŸ olun. HeÃ§ bir qeydiyyat tÉ™lÉ™b olunmur, bir dÃ¼ymÉ™ ilÉ™ sÃ¶hbÉ™tÉ™ baÅŸlayÄ±n.</p>
        
        <h3>NiyÉ™ AxtarGet seÃ§mÉ™lisiniz?</h3>
        <ul>
            <li>TamamilÉ™ pulsuz - heÃ§ bir Ã¶dÉ™niÅŸ yoxdur</li>
            <li>QeydiyyatsÄ±z - email vÉ™ ya ÅŸifrÉ™ tÉ™lÉ™b olunmur</li>
            <li>Tez qoÅŸulma - 5 saniyÉ™dÉ™ sÃ¶hbÉ™tÉ™ baÅŸlayÄ±n</li>
            <li>TÉ™hlÃ¼kÉ™siz - ÅŸÉ™xsi mÉ™lumatlarÄ±nÄ±z qorunur</li>
            <li>Asan istifadÉ™ - hÉ™r kÉ™s Ã¼Ã§Ã¼n sadÉ™ interfeys</li>
        </ul>
        
        <h3>AxtarGet nÉ™ Ã¼Ã§Ã¼ndÃ¼r?</h3>
        <p>AxtarGet platformasÄ± aÅŸaÄŸÄ±dakÄ±lar Ã¼Ã§Ã¼n idealdÄ±r:</p>
        <ul>
            <li>Yeni dostlar tapmaq</li>
            <li>SÃ¶hbÉ™t etmÉ™k</li>
            <li>TanÄ±ÅŸ olmaq</li>
            <li>Vaxt keÃ§irmÉ™k</li>
            <li>Online É™ylÉ™nmÉ™k</li>
        </ul>
        
        <h3>Tez-tez axtarÄ±lan aÃ§ar sÃ¶zlÉ™r:</h3>
        <p>pulsuz chat, online chat, AzÉ™rbaycan chat, chat otaÄŸÄ±, tanÄ±ÅŸlÄ±q saytÄ±, dost axtarmaq, virtual tanÄ±ÅŸlÄ±q, sÃ¶hbÉ™t etmÉ™k, random chat, online sÃ¶hbÉ™t, yeni insanlarla tanÄ±ÅŸ olmaq, chat platformasÄ±, pulsuz tanÄ±ÅŸlÄ±q, internetdÉ™ tanÄ±ÅŸlÄ±q, chat app, chat saytÄ±, AzÉ™rbaycanda chat</p>
        
        <p><strong>AxtarGet</strong> AzÉ™rbaycanda É™n populyar chat platformasÄ±dÄ±r. GÃ¼ndÉ™ minlÉ™rlÉ™ istifadÉ™Ã§i bizim platformamÄ±zda yeni dostlar tapÄ±r. Siz dÉ™ qoÅŸulun vÉ™ yeni insanlarla tanÄ±ÅŸ olun!</p>
    </div>

    <!-- WhatsApp Balonu -->
    <div id="whatsapp-ballon" class="whatsapp-ballon">
        <div class="whatsapp-tooltip">
            DÉ™stÉ™k Ã¼Ã§Ã¼n yazÄ±n
        </div>
        <svg viewBox="0 0 32 32">
            <path d=" M19.11 17.205c-.372 0-1.088 1.39-1.518 1.39a.63.63 0 0 1-.315-.1c-.802-.402-1.504-.817-2.163-1.447-.545-.516-1.146-1.29-1.46-1.963a.426.426 0 0 1-.073-.215c0-.33.99-.945.99-1.49 0-.143-.73-2.09-.832-2.335-.143-.372-.214-.487-.6-.487-.187 0-.36-.043-.53-.043-.302 0-.53.115-.746.315-.688.645-1.032 1.318-1.06 2.264v.114c-.015.99.472 1.977 1.017 2.78 1.23 1.82 2.506 3.41 4.554 4.34.616.287 2.035.888 2.722.888.817 0 2.15-.515 2.478-1.318.13-.33.244-.73.244-1.088 0-.058 0-.144-.03-.215-.1-.172-2.434-1.39-2.678-1.39zm-2.908 7.593c-1.747 0-3.48-.53-4.942-1.49L7.793 24.41l1.132-3.337a8.955 8.955 0 0 1-1.72-5.272c0-4.955 4.04-8.995 8.997-8.995S25.2 10.845 25.2 15.8c0 4.958-4.04 8.998-8.998 8.998zm0-19.798c-5.96 0-10.8 4.842-10.8 10.8 0 1.964.53 3.898 1.546 5.574L5 27.176l5.974-1.92a10.807 10.807 0 0 0 16.03-9.455c0-5.958-4.842-10.8-10.802-10.8z" fill-rule="evenodd"></path>
        </svg>
    </div>

    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-2xl">
            <!-- Start Screen -->
            <div id="start-screen" class="space-y-8 animate-fade-in">
                <!-- Header -->
                <header class="text-center space-y-3 mb-8">
                    <h1 class="text-5xl md:text-6xl font-bold tracking-tight">
                        <span class="gradient-text">AxtarGet</span>
                    </h1>
                    <p class="text-xl text-slate-400">Pulsuz Online Chat PlatformasÄ±</p>
                </header>

                <!-- Main Card -->
                <main class="bg-primary-light rounded-2xl p-8 card-shadow border border-slate-700 space-y-6">
                    <!-- Alert -->
                    <div class="bg-warning bg-opacity-10 border border-warning border-opacity-30 rounded-lg p-4">
                        <p class="text-warning text-sm flex items-start gap-2">
                            <span>âš ï¸</span>
                            <span><strong>DiqqÉ™t:</strong> YazÄ±ÅŸmalarÄ±nÄ±z serverdÉ™ saxlanÄ±lmÄ±r. SÃ¶hbÉ™t bitdikdÉ™ avtomatik silinir.</span>
                        </p>
                    </div>

                    <!-- Name Input -->
                    <section class="space-y-2">
                        <label for="user-name-input" class="block text-sm font-semibold text-slate-200">
                            AdÄ±nÄ±z (Ä°steÄŸe baÄŸlÄ±)
                        </label>
                        <input 
                            type="text" 
                            id="user-name-input" 
                            placeholder="AdÄ±nÄ±zÄ± yazÄ±n..." 
                            maxlength="20"
                            class="focus-ring w-full p-4 rounded-lg bg-primary border border-slate-600 text-white placeholder-slate-500 transition">
                        <p class="text-xs text-slate-400">BoÅŸ buraxsanÄ±z tÉ™sadÃ¼fi ad tÉ™yin olunacaq</p>
                    </section>

                    <!-- Start Button -->
                    <button 
                        onclick="handleStart()" 
                        class="btn-primary w-full py-4 text-lg font-bold text-white rounded-lg shadow-lg flex items-center justify-center gap-2">
                        <span>âš¡</span> SÃ¶hbÉ™tÉ™ BaÅŸla
                    </button>

                    <!-- How to Use Button -->
                    <button 
                        onclick="showTutorial()" 
                        class="w-full py-3 text-sm font-semibold text-slate-300 bg-slate-700 hover:bg-slate-600 rounded-lg transition">
                        â„¹ï¸ NecÉ™ Ä°stifadÉ™ Olunur?
                    </button>
                </main>

                <!-- Footer Info -->
                <footer class="text-center text-xs text-slate-500">
                    <p>AxtarGet - AzÉ™rbaycanda É™n yaxÅŸÄ± pulsuz chat platformasÄ±. Online tanÄ±ÅŸlÄ±q, sÃ¶hbÉ™t, yeni dostlar.</p>
                </footer>
            </div>

            <!-- Matching Screen -->
            <div id="matching-screen" class="hidden text-center space-y-6 animate-fade-in">
                <div class="bg-primary-light rounded-2xl p-12 card-shadow border border-slate-700 space-y-6">
                    <div class="flex justify-center">
                        <div class="w-20 h-20 border-4 border-slate-700 border-t-accent rounded-full spin"></div>
                    </div>
                    <div class="space-y-2">
                        <p id="matching-text" class="text-2xl font-bold">SÃ¶hbÉ™t TÉ™rÉ™fdaÅŸÄ± AxtarÄ±lÄ±r...</p>
                        <p id="countdown-text" class="text-accent text-lg font-semibold">Qalan vaxt: 20 saniyÉ™</p>
                    </div>
                    <button 
                        onclick="handleCancelMatching()" 
                        class="w-full py-3 bg-error hover:bg-red-600 text-white rounded-lg font-semibold transition">
                        âŒ LÉ™ÄŸv Et
                    </button>
                    <div id="retry-container" class="hidden space-y-3 pt-4 border-t border-slate-700">
                        <p class="text-warning font-semibold">HeÃ§ bir aktiv istifadÉ™Ã§i tapÄ±lmadÄ±</p>
                        <button 
                            onclick="handleStart()" 
                            class="btn-primary w-full py-3 text-white rounded-lg font-semibold">
                            ğŸ”„ YenidÉ™n CÉ™hd Et
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Screen -->
            <div id="chat-screen" class="hidden space-y-4 animate-fade-in">
                <!-- Chat Header -->
                <header class="bg-primary-light rounded-xl p-4 border border-slate-700 card-shadow">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3">
                                <div id="partner-status-dot" class="w-3 h-3 bg-success rounded-full"></div>
                                <div>
                                    <h2 class="font-semibold text-lg">
                                        <span id="partner-name" class="text-accent">...</span>
                                    </h2>
                                    <div id="partner-status-container" class="flex flex-col">
                                        <p id="partner-typing-status" class="text-xs status-typing opacity-0 transition-opacity flex items-center gap-1">
                                            <span>âœï¸</span>
                                            <span class="typing-dots ml-1">
                                                <span class="typing-dot"></span>
                                                <span class="typing-dot"></span>
                                                <span class="typing-dot"></span>
                                            </span>
                                            <span>yazÄ±r...</span>
                                        </p>
                                        <p id="partner-online-status" class="text-xs status-online flex items-center gap-1">
                                            <span>â—</span>
                                            <span>Aktiv</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button 
                                onclick="handleChangeChat()" 
                                class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition">
                                ğŸ”„ DÉ™yiÅŸ
                            </button>
                            <button 
                                onclick="handleCloseChat()" 
                                class="px-4 py-2 bg-error hover:bg-red-600 text-white rounded-lg text-sm font-medium transition">
                                âœ• BaÄŸla
                            </button>
                        </div>
                    </div>
                </header>

                <!-- Messages Container -->
                <main id="chat-messages" class="h-96 overflow-y-auto p-4 bg-primary-light rounded-xl border border-slate-700 space-y-4 custom-scrollbar"></main>

                <!-- Message Input -->
                <section class="flex gap-2">
                    <input 
                        type="text" 
                        id="message-input" 
                        placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." 
                        class="focus-ring flex-grow p-4 rounded-lg bg-primary-light border border-slate-600 text-white placeholder-slate-500 transition"
                        onkeypress="if(event.key === 'Enter') sendMessage()"
                        oninput="handleTyping()">
                    <button 
                        onclick="sendMessage()" 
                        class="btn-primary px-6 py-4 text-white rounded-lg font-semibold flex items-center gap-2 transition">
                        <span>â¤</span>
                    </button>
                </section>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorial-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 animate-fade-in">
        <div class="bg-primary-light rounded-2xl p-8 max-w-xl w-full card-shadow border border-slate-700 max-h-96 overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold gradient-text">AxtarGet NecÉ™ Ä°stifadÉ™ Olunur?</h2>
                <button onclick="closeTutorial()" class="text-slate-400 hover:text-white text-2xl">âœ•</button>
            </div>

            <div class="space-y-6">
                <!-- Step 1 -->
                <div class="space-y-2">
                    <div class="flex items-start gap-3">
                        <div class="bg-error text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">1</div>
                        <div>
                            <h3 class="font-bold text-error text-lg">AdÄ±nÄ±zÄ± YazÄ±n (Ä°steÄŸe BaÄŸlÄ±)</h3>
                            <p class="text-slate-300 text-sm mt-1">AdÄ±nÄ±zÄ± yazÄ±n vÉ™ ya boÅŸ buraxÄ±n. BoÅŸ buraxsanÄ±z, sistem tÉ™sadÃ¼fi ad verÉ™cÉ™k</p>
                        </div>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="space-y-2">
                    <div class="flex items-start gap-3">
                        <div class="bg-error text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">2</div>
                        <div>
                            <h3 class="font-bold text-error text-lg">SÃ¶hbÉ™tÉ™ BaÅŸlayÄ±n</h3>
                            <p class="text-slate-300 text-sm mt-1">"SÃ¶hbÉ™tÉ™ BaÅŸla" dÃ¼ymÉ™sinÉ™ basÄ±n. Sistem sizi digÉ™r istifadÉ™Ã§ilÉ™rlÉ™ qoÅŸacaq</p>
                        </div>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="space-y-2">
                    <div class="flex items-start gap-3">
                        <div class="bg-error text-white rounded-full w-8 h-8 flex items-center justify-center font-bold flex-shrink-0">3</div>
                        <div>
                            <h3 class="font-bold text-error text-lg">SÃ¶hbÉ™t Edin</h3>
                            <p class="text-slate-300 text-sm mt-1">QarÅŸÄ± tÉ™rÉ™flÉ™ sÃ¶hbÉ™t edin. Statusunu gÃ¶rÉ™ bilÉ™rsiniz (Aktiv/YazÄ±r)</p>
                        </div>
                    </div>
                </div>

                <!-- Additional Tips -->
                <div class="bg-primary p-4 rounded-lg border border-accent border-opacity-30">
                    <p class="text-xs text-slate-400 leading-relaxed">
                        ğŸ’¡ <strong>MÉ™slÉ™hÉ™t:</strong> DigÉ™r istifadÉ™Ã§ilÉ™rÉ™ hÃ¶rmÉ™tlÉ™ yanaÅŸÄ±n. AxtarGet platformasÄ± hamÄ± Ã¼Ã§Ã¼n tÉ™hlÃ¼kÉ™siz mÃ¼hit yaratmaq Ã¼Ã§Ã¼n Ã§alÄ±ÅŸÄ±r.
                    </p>
                </div>
            </div>

            <button 
                onclick="closeTutorial()" 
                class="btn-primary w-full mt-6 py-3 text-white rounded-lg font-semibold">
                BaÅŸa dÃ¼ÅŸdÃ¼m, SÃ¶hbÉ™tÉ™ BaÅŸlayaq!
            </button>
        </div>
    </div>

    <!-- Loading Animation Overlays -->
    <div id="auth-animation" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-40">
        <div class="text-center space-y-4">
            <div class="w-16 h-16 border-4 border-slate-700 border-t-accent rounded-full spin mx-auto"></div>
            <p class="text-lg font-semibold">SistemÉ™ qoÅŸulur...</p>
        </div>
    </div>

    <div id="cancel-animation" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-40">
        <div class="text-center space-y-4">
            <div class="w-16 h-16 border-4 border-slate-700 border-t-error rounded-full spin mx-auto"></div>
            <p class="text-lg font-semibold">AxtarÄ±ÅŸ dayandÄ±rÄ±lÄ±r...</p>
        </div>
    </div>

    <div id="change-animation" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-40">
        <div class="text-center space-y-4">
            <div class="w-16 h-16 border-4 border-slate-700 border-t-accent rounded-full spin mx-auto"></div>
            <p class="text-lg font-semibold">Yeni sÃ¶hbÉ™t axtarÄ±lÄ±r...</p>
        </div>
    </div>

    <div id="close-animation" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-40">
        <div class="text-center space-y-4">
            <div class="w-16 h-16 border-4 border-slate-700 border-t-error rounded-full spin mx-auto"></div>
            <p class="text-lg font-semibold">SÃ¶hbÉ™t baÄŸlanÄ±r...</p>
        </div>
    </div>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #06b6d4;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #0891b2;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, runTransaction, deleteDoc, serverTimestamp, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAbLWwzSE9WgqFKK_n9hqsl5mokZlNacM",
            authDomain: "axtargetbot.firebaseapp.com",
            projectId: "axtargetbot",
            storageBucket: "axtargetbot.firebasestorage.app",
            messagingSenderId: "509543495829",
            appId: "1:509543495829:web:833feb9c271328f8e4039c",
            measurementId: "G-DS98Q6L5WF"
        };

        let app, db, auth;
        let userId = null;
        let userName = null;
        let chatId = null;
        let partnerId = null;
        let isAuthReady = false;
        let unsubscribeChat = null;
        let matchingTimeout = null;
        let typingTimeout = null;
        let heartbeatInterval = null;
        let partnerHeartbeatInterval = null;
        let renderedMessageIds = new Set();
        let isFirstSnapshot = true;
        let lastPartnerHeartbeat = null;

        const MATCHING_SECONDS = 20;
        const CHAT_COLLECTION = `artifacts/axtarget-anonimchat/public/data/chats`;
        const MATCH_QUEUE_DOC_NAME = 'match_queue_doc';
        const HEARTBEAT_TIMEOUT = 10000; // 10 saniyÉ™

        // WhatsApp Balonu FonksiyalarÄ±
        function showWhatsAppBallon() {
            const ballon = document.getElementById('whatsapp-ballon');
            if (ballon) {
                ballon.style.display = 'flex';
            }
        }

        function hideWhatsAppBallon() {
            const ballon = document.getElementById('whatsapp-ballon');
            if (ballon) {
                ballon.style.display = 'none';
            }
        }

        // WhatsApp aÃ§Ä±lÄ±ÅŸ
        document.getElementById('whatsapp-ballon').addEventListener('click', function() {
            const phoneNumber = '0606006162';
            const message = encodeURIComponent('Salam dÉ™stÉ™yÉ™ ehtiyacÄ±m var');
            window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
        });

        // Tutorial Functions
        window.showTutorial = function() {
            document.getElementById('tutorial-modal').classList.remove('hidden');
        };

        window.closeTutorial = function() {
            document.getElementById('tutorial-modal').classList.add('hidden');
        };

        // Screen Management
        function showScreen(screenId) {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('matching-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
            
            // WhatsApp balonu gÃ¶stÉ™r/gizlÉ™t
            if (screenId === 'start-screen') {
                showWhatsAppBallon();
            } else {
                hideWhatsAppBallon();
            }
        }

        function showAnimation(animationId) {
            document.getElementById('auth-animation').classList.add('hidden');
            document.getElementById('cancel-animation').classList.add('hidden');
            document.getElementById('change-animation').classList.add('hidden');
            document.getElementById('close-animation').classList.add('hidden');
            document.getElementById(animationId).classList.remove('hidden');
        }

        function hideAllAnimations() {
            document.getElementById('auth-animation').classList.add('hidden');
            document.getElementById('cancel-animation').classList.add('hidden');
            document.getElementById('change-animation').classList.add('hidden');
            document.getElementById('close-animation').classList.add('hidden');
        }

        // Firebase Initialize
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("âœ… Firebase auth hazÄ±r, User ID:", userId);
                    } else {
                        console.log("ğŸ”„ Firebase auth baÅŸlatÄ±lÄ±yor...");
                        await signInAnonymously(auth);
                    }
                });
            } catch (e) {
                console.error("Firebase xÉ™tasÄ±:", e);
            }
        }

        // Heartbeat System
        function startHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(async () => {
                if (userId && chatId) {
                    try {
                        const userRef = doc(db, CHAT_COLLECTION, userId);
                        await updateDoc(userRef, {
                            lastSeen: serverTimestamp(),
                            isOnline: true,
                            heartbeat: serverTimestamp()
                        });
                        console.log("ğŸ’“ Heartbeat gÃ¶ndÉ™rildi");
                    } catch (e) {
                        console.error("Heartbeat xÉ™tasÄ±:", e);
                    }
                }
            }, 3000);
        }

        function startPartnerHeartbeatCheck() {
            if (partnerHeartbeatInterval) clearInterval(partnerHeartbeatInterval);
            
            partnerHeartbeatInterval = setInterval(async () => {
                if (partnerId && chatId) {
                    try {
                        const partnerRef = doc(db, CHAT_COLLECTION, partnerId);
                        const partnerDoc = await getDoc(partnerRef);
                        
                        if (partnerDoc.exists()) {
                            const partnerData = partnerDoc.data();
                            const lastHeartbeat = partnerData.heartbeat?.toDate?.() || partnerData.lastSeen?.toDate?.();
                            
                            if (lastHeartbeat) {
                                const now = new Date();
                                const diff = now - lastHeartbeat;
                                
                                const statusDot = document.getElementById('partner-status-dot');
                                const onlineStatus = document.getElementById('partner-online-status');
                                
                                if (diff < HEARTBEAT_TIMEOUT) {
                                    // Aktiv
                                    statusDot.className = 'w-3 h-3 bg-success rounded-full';
                                    onlineStatus.innerHTML = '<span>â—</span><span>Aktiv</span>';
                                    onlineStatus.className = 'text-xs status-online flex items-center gap-1';
                                } else {
                                    // Ofline
                                    statusDot.className = 'w-3 h-3 bg-gray-500 rounded-full';
                                    onlineStatus.innerHTML = '<span>â—</span><span>Ofline</span>';
                                    onlineStatus.className = 'text-xs text-gray-400 flex items-center gap-1';
                                }
                            }
                        }
                    } catch (e) {
                        console.error("Partner heartbeat check xÉ™tasÄ±:", e);
                    }
                }
            }, 5000);
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            if (partnerHeartbeatInterval) {
                clearInterval(partnerHeartbeatInterval);
                partnerHeartbeatInterval = null;
            }
        }

        // Message UI
        function addMessageToUI(senderName, text, isSelf, messageId = null) {
            if (messageId && renderedMessageIds.has(messageId)) return;

            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            const time = new Date().toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' });

            if (messageId) {
                messageElement.setAttribute('data-message-id', messageId);
                renderedMessageIds.add(messageId);
            }

            messageElement.classList.add('message-bubble');

            if (isSelf) {
                messageElement.className = 'message-bubble max-w-xs ml-auto p-4 rounded-xl bg-accent text-primary font-medium';
                messageElement.innerHTML = `
                    <div class="flex justify-between items-end gap-2 mb-1">
                        <p class="text-xs font-bold opacity-70">Siz</p>
                        <span class="text-[10px] opacity-60">${time}</span>
                    </div>
                    <p class="break-words text-sm">${escapeHtml(text)}</p>
                `;
            } else {
                messageElement.className = 'message-bubble max-w-xs p-4 rounded-xl bg-primary border border-slate-700';
                messageElement.innerHTML = `
                    <div class="flex justify-between items-end gap-2 mb-1">
                        <p class="text-xs font-bold text-accent">${escapeHtml(senderName)}</p>
                        <span class="text-[10px] text-slate-500">${time}</span>
                    </div>
                    <p class="break-words text-sm text-slate-200">${escapeHtml(text)}</p>
                `;
            }

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addSystemMessageToUI(text) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'text-center my-3';
            messageElement.innerHTML = `<span class="text-xs text-warning p-2 bg-primary border border-warning border-opacity-30 rounded-lg inline-block">${escapeHtml(text)}</span>`;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Typing Handler - FIXED!
        window.handleTyping = async function() {
            if (!chatId || !userId) {
                console.log("âŒ handleTyping: chatId veya userId yok");
                return;
            }
            
            const input = document.getElementById('message-input');
            const hasText = input.value.trim().length > 0;
            
            console.log("âœï¸ Yazma durumu:", hasText ? "YazÄ±yor" : "YazmÄ±yor");
            
            if (typingTimeout) clearTimeout(typingTimeout);

            try {
                await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
                    [`typingStatus.${userId}`]: hasText,
                    lastActivity: serverTimestamp()
                });
                console.log("âœ… Yazma durumu gÃ¼ncellendi:", hasText);
            } catch (e) {
                console.error("âŒ Yazma statusu xÉ™tasÄ±:", e);
            }

            typingTimeout = setTimeout(async () => {
                try {
                    await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
                        [`typingStatus.${userId}`]: false
                    });
                    console.log("âœ… Yazma durumu temizlendi (false)");
                } catch (e) {
                    console.error("âŒ Yazma durumu temizleme hatasÄ±:", e);
                }
            }, 2000);
        };

        // Send Message
        window.sendMessage = async function() {
            const input = document.getElementById('message-input');
            const messageText = input.value.trim();
            if (!messageText || !chatId || !userId) {
                console.log("âŒ Mesaj gÃ¶nderme: BoÅŸ mesaj veya chatId/userId yok");
                return;
            }

            console.log("ğŸ“¤ Mesaj gÃ¶nderiliyor:", messageText.substring(0, 50) + "...");
            
            input.value = '';
            input.focus();

            try {
                const messageData = {
                    senderId: userId,
                    senderName: userName,
                    text: messageText,
                    timestamp: new Date().toISOString()
                };

                await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
                    [`typingStatus.${userId}`]: false,
                    messages: arrayUnion(messageData),
                    lastActivity: serverTimestamp()
                });
                
                console.log("âœ… Mesaj baÅŸarÄ±yla gÃ¶nderildi");
            } catch (e) {
                console.error("âŒ Mesaj gÃ¶ndÉ™rmÉ™ xÉ™tasÄ±:", e);
                input.value = messageText;
                addSystemMessageToUI("âš ï¸ Mesaj gÃ¶ndÉ™rilÉ™ bilmÉ™di");
            }
        };

        // Start Chat
        window.handleStart = async function() {
            if (!isAuthReady || !userId) {
                console.log("âŒ handleStart: Auth hazÄ±r deÄŸil");
                showAnimation('auth-animation');
                setTimeout(() => {
                    hideAllAnimations();
                }, 1000); // 2000ms -> 1000ms
                return;
            }

            const inputName = document.getElementById('user-name-input').value.trim();
            userName = inputName || `Ä°stifadÉ™Ã§i-${userId.substring(0, 6)}`;
            
            console.log("ğŸš€ Sohbet baÅŸlatÄ±lÄ±yor, kullanÄ±cÄ± adÄ±:", userName);

            showScreen('matching-screen');
            document.getElementById('retry-container').classList.add('hidden');
            document.getElementById('matching-text').textContent = "SÃ¶hbÉ™t TÉ™rÉ™fdaÅŸÄ± AxtarÄ±lÄ±r...";
            startMatching();
        };

        // Matching Logic
        async function startMatching() {
            const queueRef = doc(db, CHAT_COLLECTION, MATCH_QUEUE_DOC_NAME);
            let remaining = MATCHING_SECONDS;
            document.getElementById('countdown-text').textContent = `Qalan vaxt: ${remaining} saniyÉ™`;

            console.log("ğŸ” EÅŸleÅŸme baÅŸlatÄ±ldÄ±");

            if (matchingTimeout) clearInterval(matchingTimeout);
            matchingTimeout = setInterval(() => {
                remaining--;
                document.getElementById('countdown-text').textContent = `Qalan vaxt: ${remaining} saniyÉ™`;

                if (remaining <= 0) {
                    clearInterval(matchingTimeout);
                    document.getElementById('matching-text').textContent = "Aktiv istifadÉ™Ã§i tapÄ±lmadÄ±";
                    document.getElementById('countdown-text').textContent = "ZÉ™hmÉ™t olmasa yenidÉ™n dene";
                    document.getElementById('retry-container').classList.remove('hidden');
                    handleCancelMatching();
                }
            }, 1000);

            try {
                await runTransaction(db, async (transaction) => {
                    const queueDoc = await transaction.get(queueRef);

                    if (queueDoc.exists() && queueDoc.data().waitingUserId && queueDoc.data().waitingUserId !== userId) {
                        const waiting = queueDoc.data();
                        const waitingUserRef = doc(db, CHAT_COLLECTION, waiting.waitingUserId);
                        const waitingUserDoc = await transaction.get(waitingUserRef);

                        if (!waitingUserDoc.exists() || !waitingUserDoc.data().isOnline) {
                            console.log("â³ Bekleyen kullanÄ±cÄ± offline, sÄ±raya ekleniyor...");
                            
                            transaction.set(queueRef, {
                                waitingUserId: null,
                                waitingUserName: null,
                                timestamp: serverTimestamp()
                            });

                            transaction.set(queueRef, {
                                waitingUserId: userId,
                                waitingUserName: userName,
                                timestamp: serverTimestamp()
                            });

                            transaction.set(doc(db, CHAT_COLLECTION, userId), {
                                status: 'waiting',
                                userName: userName,
                                isOnline: true,
                                lastSeen: serverTimestamp(),
                                heartbeat: serverTimestamp(),
                                _timestamp: serverTimestamp()
                            });

                            startHeartbeat();
                            setupMatchingListener();
                            return;
                        }

                        partnerId = waiting.waitingUserId;
                        chatId = doc(collection(db, CHAT_COLLECTION)).id;
                        
                        console.log("ğŸ‰ EÅŸleÅŸme bulundu!", {
                            partnerId: partnerId,
                            partnerName: waiting.waitingUserName,
                            chatId: chatId
                        });

                        const newChat = {
                            createdAt: serverTimestamp(),
                            users: {
                                [userId]: { name: userName },
                                [partnerId]: { name: waiting.waitingUserName }
                            },
                            messages: [],
                            typingStatus: { [userId]: false, [partnerId]: false },
                            status: 'active',
                            lastActivity: serverTimestamp()
                        };

                        transaction.set(doc(db, CHAT_COLLECTION, chatId), newChat);
                        transaction.set(queueRef, { waitingUserId: null, waitingUserName: null, timestamp: serverTimestamp() });

                        transaction.set(doc(db, CHAT_COLLECTION, partnerId), {
                            matched: true,
                            chatId: chatId,
                            partnerId: userId,
                            partnerName: userName,
                            isOnline: true,
                            heartbeat: serverTimestamp(),
                            _timestamp: serverTimestamp()
                        });

                        document.getElementById('partner-name').textContent = waiting.waitingUserName;
                        clearInterval(matchingTimeout);

                        setTimeout(() => {
                            showScreen('chat-screen');
                            setupChatListener();
                            startHeartbeat();
                            startPartnerHeartbeatCheck();
                        }, 500);

                    } else {
                        console.log("â³ SÄ±raya ekleniyor...");
                        
                        transaction.set(queueRef, {
                            waitingUserId: userId,
                            waitingUserName: userName,
                            timestamp: serverTimestamp()
                        });

                        transaction.set(doc(db, CHAT_COLLECTION, userId), {
                            status: 'waiting',
                            userName: userName,
                            isOnline: true,
                            lastSeen: serverTimestamp(),
                            heartbeat: serverTimestamp(),
                            _timestamp: serverTimestamp()
                        });

                        startHeartbeat();
                        setupMatchingListener();
                    }
                });
            } catch (e) {
                console.error("âŒ Matching xÉ™tasÄ±:", e);
                addSystemMessageToUI("âš ï¸ AxtarÄ±ÅŸ xÉ™tasÄ±");
            }
        }

        // Matching Listener
        function setupMatchingListener() {
            const userRef = doc(db, CHAT_COLLECTION, userId);
            if (unsubscribeChat) unsubscribeChat();

            console.log("ğŸ‘‚ EÅŸleÅŸme dinleyicisi kuruluyor...");

            unsubscribeChat = onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().matched) {
                    const data = docSnap.data();
                    chatId = data.chatId;
                    partnerId = data.partnerId;

                    console.log("ğŸ‰ EÅŸleÅŸme dinleyicisi: Partner bulundu!", {
                        partnerId: partnerId,
                        partnerName: data.partnerName,
                        chatId: chatId
                    });
                    
                    document.getElementById('partner-name').textContent = data.partnerName;

                    if (unsubscribeChat) unsubscribeChat();
                    if (matchingTimeout) clearInterval(matchingTimeout);

                    setTimeout(() => {
                        showScreen('chat-screen');
                        setupChatListener();
                        deleteDoc(userRef).catch(() => {});
                    }, 500);
                }
            });
        }

        // Chat Listener - FIXED!
        function setupChatListener() {
            if (!chatId) {
                console.log("âŒ setupChatListener: chatId yok");
                return;
            }

            const chatRef = doc(db, CHAT_COLLECTION, chatId);
            const messagesContainer = document.getElementById('chat-messages');
            const typingElement = document.getElementById('partner-typing-status');

            if (unsubscribeChat) unsubscribeChat();

            messagesContainer.innerHTML = '';
            renderedMessageIds.clear();
            isFirstSnapshot = true;

            console.log("ğŸ‘‚ Chat dinleyicisi kuruluyor, chatId:", chatId);

            unsubscribeChat = onSnapshot(chatRef, (docSnap) => {
                if (!docSnap.exists()) {
                    if (isFirstSnapshot) {
                        console.log("ğŸ“ Ä°lk snapshot - chat henÃ¼z hazÄ±r deÄŸil");
                        isFirstSnapshot = false;
                        return;
                    }

                    console.log("âŒ Chat document silindi");
                    if (unsubscribeChat) unsubscribeChat();
                    addSystemMessageToUI("âŒ TÉ™rÉ™fdaÅŸ sÃ¶hbÉ™ti baÄŸladÄ±");
                    setTimeout(() => disconnect(true), 2000);
                    return;
                }

                isFirstSnapshot = false;
                const data = docSnap.data();

                if (data.status === 'active') {
                    // TYPING STATUS FIX - Burada dÃ¼zeltildi!
                    const isTyping = data.typingStatus?.[partnerId];
                    console.log("âœï¸ KarÅŸÄ± taraf yazma durumu:", isTyping ? "YAZIYOR" : "YAZMIYOR");
                    
                    if (isTyping) {
                        typingElement.classList.remove('opacity-0');
                        console.log("âœ… YazÄ±yor gÃ¶steriliyor");
                    } else {
                        typingElement.classList.add('opacity-0');
                        console.log("âŒ YazmÄ±yor gizleniyor");
                    }

                    const messages = data.messages || [];
                    console.log(`ğŸ“¨ ${messages.length} mesaj var`);
                    
                    messages.forEach((msg, index) => {
                        const messageId = `${msg.senderId}-${msg.timestamp}-${index}`;
                        if (!renderedMessageIds.has(messageId)) {
                            console.log(`ğŸ“ Yeni mesaj: ${msg.senderName}: ${msg.text.substring(0, 30)}...`);
                            addMessageToUI(msg.senderName, msg.text, msg.senderId === userId, messageId);
                        }
                    });
                } else if (data.status === 'closed') {
                    if (data.closedBy !== userId) {
                        console.log("âŒ KarÅŸÄ± taraf sohbeti kapattÄ±");
                        if (unsubscribeChat) unsubscribeChat();
                        addSystemMessageToUI("âŒ TÉ™rÉ™fdaÅŸ sÃ¶hbÉ™ti baÄŸladÄ±");
                        setTimeout(() => disconnect(true), 2000);
                    }
                }
            }, (error) => {
                console.error("âŒ Chat dinleyici hatasÄ±:", error);
            });
        }

        // Disconnect
        async function disconnect(backToStart = true) {
            console.log("ğŸ”Œ BaÄŸlantÄ± kesiliyor...");
            stopHeartbeat();

            if (unsubscribeChat) {
                unsubscribeChat();
                unsubscribeChat = null;
            }
            if (matchingTimeout) {
                clearInterval(matchingTimeout);
                matchingTimeout = null;
            }
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }

            try {
                const queueRef = doc(db, CHAT_COLLECTION, MATCH_QUEUE_DOC_NAME);
                await runTransaction(db, async (transaction) => {
                    const queueDoc = await transaction.get(queueRef);
                    if (queueDoc.exists() && queueDoc.data().waitingUserId === userId) {
                        transaction.set(queueRef, {
                            waitingUserId: null,
                            waitingUserName: null,
                            timestamp: serverTimestamp()
                        });
                    }
                });
            } catch (e) {
                console.log("Queue cleanup error:", e);
            }

            try {
                await deleteDoc(doc(db, CHAT_COLLECTION, userId));
            } catch (e) {
                console.log("User doc delete error:", e);
            }

            chatId = null;
            partnerId = null;
            renderedMessageIds.clear();

            if (backToStart) {
                showScreen('start-screen');
                document.getElementById('user-name-input').value = '';
            }
        }

        // Close Chat
        window.handleCloseChat = async function() {
            console.log("âŒ Sohbet kapatÄ±lÄ±yor");
            showAnimation('close-animation');

            setTimeout(async () => {
                hideAllAnimations();

                if (!chatId) {
                    await disconnect(true);
                    return;
                }

                const currentChatId = chatId;

                try {
                    await updateDoc(doc(db, CHAT_COLLECTION, currentChatId), {
                        status: 'closed',
                        closedBy: userId
                    });
                } catch (e) {
                    console.error("Close error:", e);
                }

                await disconnect(true);

                setTimeout(() => {
                    try {
                        deleteDoc(doc(db, CHAT_COLLECTION, currentChatId));
                        deleteDoc(doc(db, CHAT_COLLECTION, userId));
                        if (partnerId) deleteDoc(doc(db, CHAT_COLLECTION, partnerId));
                    } catch (e) {}
                }, 500); // 2000ms -> 500ms
            }, 500); // 1500ms -> 500ms
        };

        // Change Chat
        window.handleChangeChat = async function() {
            console.log("ğŸ”„ Sohbet deÄŸiÅŸtiriliyor");
            showAnimation('change-animation');

            setTimeout(async () => {
                hideAllAnimations();

                if (!chatId) return;

                const currentChatId = chatId;

                try {
                    await updateDoc(doc(db, CHAT_COLLECTION, currentChatId), {
                        status: 'closed',
                        closedBy: userId
                    });
                } catch (e) {}

                await disconnect(false);
                await new Promise(resolve => setTimeout(resolve, 300)); // 500ms -> 300ms

                setTimeout(() => {
                    try {
                        deleteDoc(doc(db, CHAT_COLLECTION, currentChatId));
                        deleteDoc(doc(db, CHAT_COLLECTION, userId));
                        if (partnerId) deleteDoc(doc(db, CHAT_COLLECTION, partnerId));
                    } catch (e) {}
                }, 300); // 1000ms -> 300ms

                showScreen('matching-screen');
                document.getElementById('matching-text').textContent = "Yeni TÉ™rÉ™fdaÅŸ AxtarÄ±lÄ±r...";
                document.getElementById('retry-container').classList.add('hidden');
                startMatching();
            }, 300); // 1500ms -> 300ms
        };

        // Cancel Matching
        window.handleCancelMatching = async function() {
            console.log("âŒ EÅŸleÅŸme iptal ediliyor");
            showAnimation('cancel-animation');

            setTimeout(async () => {
                hideAllAnimations();
                await disconnect(false);
                showScreen('start-screen');
            }, 300); // 1500ms -> 300ms
        };

        // Cleanup on Browser Close
        window.addEventListener('beforeunload', async (e) => {
            if (userId) {
                stopHeartbeat();
                try {
                    if (chatId) {
                        await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
                            status: 'closed',
                            closedBy: userId
                        });
                    }
                    await deleteDoc(doc(db, CHAT_COLLECTION, userId));

                    const queueRef = doc(db, CHAT_COLLECTION, MATCH_QUEUE_DOC_NAME);
                    await runTransaction(db, async (transaction) => {
                        const queueDoc = await transaction.get(queueRef);
                        if (queueDoc.exists() && queueDoc.data().waitingUserId === userId) {
                            transaction.set(queueRef, { waitingUserId: null, waitingUserName: null });
                        }
                    });
                } catch (err) {
                    console.log("Cleanup error:", err);
                }
            }
        });

        // Tab Visibility
        document.addEventListener('visibilitychange', async () => {
            if (document.hidden) {
                stopHeartbeat();
            } else {
                if (userId && chatId) {
                    startHeartbeat();
                    startPartnerHeartbeatCheck();
                }
            }
        });

        // Ä°lk WhatsApp balonunu gÃ¶ster
        window.onload = function() {
            initializeFirebase();
            showWhatsAppBallon();
        };
    </script>
</body>
</html>
