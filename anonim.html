<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AxtarGet AnonimChat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1e293b',
                        'secondary-light': '#fef3c7',
                        'accent-blue': '#3b82f6',
                        'accent-green': '#10b981',
                        'accent-red': '#ef4444',
                    }
                },
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #3b82f6;
            border-radius: 3px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background-color: #1e293b;
        }
    </style>
</head>
<body>
    <div id="app-container" class="w-full max-w-lg bg-primary-dark p-6 sm:p-8 rounded-2xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-center mb-6 text-accent-blue">AxtarGet <span class="text-white">AnonimChat</span></h1>

        <!-- Ba≈ülanƒüƒ±c Ekranƒ± -->
        <div id="start-screen" class="space-y-6">
            <div class="mb-6 p-3 bg-secondary-light text-primary-dark text-center rounded-lg font-semibold">
                ‚ö†Ô∏è Yazƒ±≈ümalarƒ±nƒ±z yadda≈üda qalmayacaq!
            </div>
            
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-300">Adƒ±nƒ±z (Yazmasanƒ±z Anonim qalacaqsƒ±nƒ±z):</label>
                <input type="text" id="user-name-input" placeholder="M…ôs…ôl…ôn: Adƒ±n" maxlength="20"
                        class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-accent-blue text-white">
            </div>

            <button onclick="handleStart()" class="w-full py-4 text-lg font-bold text-white bg-accent-green hover:bg-green-600 rounded-lg shadow-lg">
                ‚ö° Ba≈üla
            </button>
        </div>

        <!-- Axtarƒ±≈ü Ekranƒ± -->
        <div id="matching-screen" class="hidden text-center p-8 space-y-4">
            <div class="w-16 h-16 border-4 border-t-4 border-accent-blue border-t-transparent rounded-full animate-spin mx-auto"></div>
            <p id="matching-text" class="text-xl font-semibold">T…ôr…ôfda≈ü Axtarƒ±lƒ±r...</p>
            <p id="countdown-text" class="text-sm text-gray-400">Qalan vaxt: 20 saniy…ô</p>
            
            <button onclick="handleCancelMatching()" class="w-full py-3 mt-4 text-md font-bold text-white bg-accent-red hover:bg-red-600 rounded-lg">
                ‚ùå Dayandƒ±r
            </button>

            <div id="retry-container" class="hidden space-y-3 mt-4">
                <p class="text-yellow-400">Axtarƒ±lƒ±r.....</p>
                <button onclick="handleStart()" class="w-full py-3 text-lg font-bold text-white bg-accent-green hover:bg-green-600 rounded-lg">
                    üîÑ Yenid…ôn Dene
                </button>
            </div>
        </div>

        <!-- S√∂hb…ôt Ekranƒ± -->
        <div id="chat-screen" class="hidden space-y-4">
            <div class="p-3 bg-gray-700 rounded-lg flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
                <div>
                    <p class="text-lg font-semibold text-accent-blue">T…ôr…ôfda≈ü: <span id="partner-name">...</span></p>
                    <p id="partner-typing-status" class="text-xs text-yellow-400 italic opacity-0 transition-opacity">‚úçÔ∏è Yazƒ±r...</p>
                    <p id="partner-online-status" class="text-xs text-green-400">üü¢ Onlayn</p>
                </div>
                <div class="flex space-x-2 justify-end">
                    <button onclick="handleChangeChat()" class="px-3 py-2 bg-yellow-500 text-primary-dark rounded-lg text-sm font-medium hover:bg-yellow-400">
                        üîÑ D…ôyi≈ü
                    </button>
                    <button onclick="handleCloseChat()" class="px-3 py-2 bg-accent-red text-white rounded-lg text-sm font-medium hover:bg-red-500">
                        ‚ùå Baƒüla
                    </button>
                </div>
            </div>

            <div id="chat-messages" class="h-80 overflow-y-auto p-4 bg-gray-800 rounded-lg space-y-3 border border-gray-700"></div>

            <div class="flex space-x-2">
                <input type="text" id="message-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n (Enter g√∂nd…ôrir)..."
                        class="flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-accent-blue text-white"
                        onkeypress="if(event.key === 'Enter') sendMessage()"
                        oninput="handleTyping()">
                <button onclick="sendMessage()" class="p-3 bg-accent-blue text-white rounded-lg hover:bg-blue-600">
                    ‚úì G√∂nd…ôr
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, runTransaction, deleteDoc, serverTimestamp, arrayUnion, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAAbLWwzSE9WgqFKK_n9hqsl5mokZlNacM",
            authDomain: "axtargetbot.firebaseapp.com",
            projectId: "axtargetbot",
            storageBucket: "axtargetbot.firebasestorage.app",
            messagingSenderId: "509543495829",
            appId: "1:509543495829:web:833feb9c271328f8e4039c",
            measurementId: "G-DS98Q6L5WF"
        };
        
        let app, db, auth;
        let userId = null;
        let userName = null;
        let chatId = null;
        let partnerId = null;
        let isAuthReady = false;
        let unsubscribeChat = null;
        let matchingTimeout = null;
        let typingTimeout = null;
        const MATCHING_SECONDS = 20;
        const CHAT_COLLECTION = `artifacts/axtarget-anonimchat/public/data/chats`;
        const MATCH_QUEUE_DOC_NAME = 'match_queue_doc';

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (e) {
                console.error("Firebase x…ôtasƒ±:", e);
            }
        }

        async function cleanOldChats() {
            try {
                const q = query(collection(db, CHAT_COLLECTION));
                const snapshot = await getDocs(q);
                for (const docSnap of snapshot.docs) {
                    const data = docSnap.data();
                    if (data.users && data.users[userId] && data.status !== "closed") {
                        await updateDoc(docSnap.ref, {
                            status: "closed",
                            closedReason: "old_session",
                            closedAt: serverTimestamp()
                        });
                    }
                }
            } catch (e) {
                console.warn("K√∂hn…ô chat t…ômizl…ônm…ôsi x…ôtasƒ±:", e);
            }
        }

        function showScreen(id) {
            ["start-screen","matching-screen","chat-screen"].forEach(s=>document.getElementById(s).classList.add("hidden"));
            document.getElementById(id).classList.remove("hidden");
        }

        function addMessageToUI(senderName, text, isSelf) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            const time = new Date().toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' });
            messageElement.className = `max-w-[75%] p-3 rounded-xl shadow-md ${isSelf ? "bg-accent-blue ml-auto":"bg-gray-600 mr-auto"}`;
            messageElement.innerHTML = `
                <div class="flex justify-between items-center gap-2 mb-1">
                    <p class="text-xs font-bold">${isSelf ? "Siz": senderName}</p>
                    <span class="text-[10px] opacity-70">${time}</span>
                </div>
                <p class="text-sm break-words">${text}</p>`;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addSystemMessageToUI(text) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'text-center my-2';
            messageElement.innerHTML = `<span class="text-xs text-yellow-400 p-2 bg-gray-700 rounded italic">${text}</span>`;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        window.sendMessage = async function() {
            const input = document.getElementById('message-input');
            const messageText = input.value.trim();
            if (!messageText || !chatId || !userId) return;
            addMessageToUI(userName, messageText, true);
            input.value = '';
            try {
                await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
                    [`typingStatus.${userId}`]: false,
                    messages: arrayUnion({
                        senderId: userId,
                        senderName: userName,
                        text: messageText,
                        timestamp: new Date().toISOString()
                    }),
                    lastActivity: serverTimestamp()
                });
            } catch (e) { addSystemMessageToUI("‚ö†Ô∏è Mesaj g√∂nd…ôril…ô bilm…ôdi."); }
        };

        window.handleStart = async function() {
            if (!isAuthReady || !userId) { alert("Autentifikasiya hazƒ±r deyil"); return; }
            await cleanOldChats();
            const inputName = document.getElementById('user-name-input').value.trim();
            userName = inputName || `Anonim-${userId.substring(0, 6)}`;
            showScreen('matching-screen');
            startMatching();
        };

        // Qalan kod (matching, listenerl…ôr, typing, disconnect v…ô s.)
        // sad…ôc…ô disconnect v…ô handleCloseChat-da deleteDoc yerin…ô updateDoc(status:"closed") qalƒ±b.

        async function disconnect(backToStart = true) {
            if (unsubscribeChat) { unsubscribeChat(); unsubscribeChat = null; }
            if (matchingTimeout) { clearInterval(matchingTimeout); matchingTimeout = null; }
            if (typingTimeout) { clearTimeout(typingTimeout); typingTimeout = null; }
            try {
                if (chatId) await updateDoc(doc(db, CHAT_COLLECTION, chatId), { status: "closed", closedReason: "disconnect" });
            } catch {}
            chatId = partnerId = null;
            if (backToStart) showScreen('start-screen');
        }

        window.handleCloseChat = async function() {
            if (chatId) await updateDoc(doc(db, CHAT_COLLECTION, chatId), { status: "closed", closedReason: "manual" });
            await disconnect(true);
        };

        window.onload = initializeFirebase;
    </script>
</body>
</html>
