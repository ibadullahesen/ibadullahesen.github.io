<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AxtarGet Bot - Biznesini Paylaş</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Tünd qara/boz fon */
            color: #e2e8f0; /* Kontrast üçün açıq boz mətn */
            min-height: 100vh; /* Səhifənin minimum hündürlüyünü təmin edir */
            display: flex;
            flex-direction: column;
        }
        .gradient-form-bg {
            background-image: linear-gradient(to bottom right, #10b981, #34d399); /* Yaşıldan açıq yaşıl qradiyent */
        }
        .section-padding {
            padding: 6rem 0; /* Bölmələr üçün ardıcıl şaquli boşluq */
        }
        .hover-grow {
            transition: transform 0.3s ease-in-out;
        }
        .hover-grow:hover {
            transform: scale(1.05);
        }
        /* Custom scrollbar for aesthetic appeal */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* Darker track */
        }
        ::-webkit-scrollbar-thumb {
            background: #10b981; /* Green thumb */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #059669; /* Darker green on hover */
        }
        .alert-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #dc2626; /* Red background */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .alert-message.show {
            opacity: 1;
        }
        .business-card {
            background-color: #2d3748; /* Card background */
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #10b981; /* Green border */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Ensures content pushes interactions to bottom */
        }
        .business-card-content {
            padding: 1.5rem;
        }
        .business-card-title {
            font-size: 1.75rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            margin-bottom: 0.5rem;
            color: #34d399; /* Light green for titles */
            text-transform: uppercase; /* İş adı böyük hərflərlə */
        }
        .business-card-category-region {
            font-size: 0.875rem; /* text-sm */
            color: #a0aec0; /* Gray text */
            margin-bottom: 0.75rem;
        }
        .business-card-about {
            font-size: 1rem; /* text-base */
            color: #e2e8f0; /* Light gray text */
            margin-bottom: 1rem;
        }
        .business-card-contact {
            font-size: 0.875rem; /* text-sm */
            color: #a0aec0;
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .business-card-contact i {
            margin-right: 0.5rem;
            color: #34d399; /* Light green icon */
        }
        .interaction-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 1rem 1.5rem;
            border-top: 1px solid #4a5568;
            background-color: #1a202c; /* Darker background for interaction bar */
        }
        .interaction-button {
            display: flex;
            align-items: center;
            color: #a0aec0;
            font-size: 1rem;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        .interaction-button:hover {
            color: #34d399;
        }
        .like-button.liked {
            color: #e53e3e; /* Red color for liked state */
        }

        /* Comment Modal Styles */
        .modal {
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #2d3748;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #e2e8f0;
            text-decoration: none;
            cursor: pointer;
        }
        .comment-list {
            max-height: 300px; /* Max height for scrollable comments */
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 10px; /* For scrollbar */
        }
        .comment-item {
            background-color: #1a202c;
            padding: 10px;
            border-radius: 0.5rem;
            margin-bottom: 8px;
            font-size: 0.9rem;
            word-break: break-word; /* Ensure long words break */
        }
        .comment-author {
            font-weight: bold;
            color: #34d399;
        }
        .comment-text {
            color: #e2e8f0;
        }
        .comment-timestamp {
            font-size: 0.75rem;
            color: #a0aec0;
            margin-top: 5px;
            text-align: right;
        }

        /* Auth Modal Styles */
        .auth-modal-content {
            background-color: #2d3748;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        /* Profile Dropdown Styles */
        .profile-dropdown {
            position: absolute;
            top: 60px; /* Adjust as needed based on header height */
            right: 1rem;
            background-color: #2d3748;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            z-index: 100;
            width: 200px;
        }
        .profile-initials {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #10b981;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            margin-left: 1rem; /* Adjust spacing from right nav items */
        }
        .profile-initials:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="relative">

    <!-- Başlıq hissəsi -->
    <header class="bg-gray-900 shadow-lg py-4 fixed w-full z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="https://placehold.co/40x40/10b981/ffffff?text=AG" alt="AxtarGet Logosu" class="rounded-full shadow-md w-10 h-10 object-cover">
                <a href="index.html" class="text-white text-2xl font-bold tracking-wide">AxtarGet</a>
            </div>
            <nav class="hidden md:flex space-x-8 items-center">
                <a href="index.html#about" class="text-gray-300 hover:text-green-400 transition-colors duration-300">Haqqımızda</a>
                <a href="index.html#functions" class="text-gray-300 hover:text-green-400 transition-colors duration-300">Funksiyalar</a>
                <!-- "Xidmət Axtarışı" linki ləğv edildi -->
                <a href="share-business.html" class="text-green-400 font-semibold transition-colors duration-300">Biznesini Paylaş</a>
                <!-- "Admin" linki ləğv edildi -->
                <a href="index.html#contact" class="text-gray-300 hover:text-green-400 transition-colors duration-300">Əlaqə</a>
                <!-- Profile Initials/Button added here -->
                <div id="profile-initials" class="profile-initials ml-4 hidden">U</div> 
            </nav>
            <!-- Mobil Menyü Düyməsi -->
            <button id="mobile-menu-button" class="md:hidden text-gray-300 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
        </div>
        <!-- Mobil Menyü -->
        <div id="mobile-menu" class="hidden md:hidden bg-gray-800 py-2">
            <a href="index.html#about" class="block px-4 py-2 text-gray-300 hover:bg-gray-700">Haqqımızda</a>
            <a href="index.html#functions" class="block px-4 py-2 text-gray-300 hover:bg-gray-700">Funksiyalar</a>
            <!-- "Xidmət Axtarışı" linki mobil menyudan ləğv edildi -->
            <a href="share-business.html" class="block px-4 py-2 text-green-400 font-semibold hover:bg-gray-700">Biznesini Paylaş</a>
            <!-- "Admin" linki mobil menyudan ləğv edildi -->
            <a href="index.html#contact" class="block px-4 py-2 text-gray-300 hover:bg-gray-700">Əlaqə</a>
            <a href="https://t.me/AxtarGetbot" target="_blank" class="block px-4 py-2 bg-green-600 text-white rounded-md mx-4 my-2 text-center hover:bg-green-700 transition-all duration-300">Botu İndi Sına</a>
        </div>
    </header>

    <!-- User Profile Dropdown -->
    <div id="user-profile-dropdown" class="profile-dropdown hidden">
        <p class="text-white text-lg font-semibold mb-2" id="dropdown-username"></p>
        <p class="text-gray-400 text-sm mb-4" id="dropdown-email"></p>
        <button id="logout-button" class="w-full py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-300">
            Çıxış Et
        </button>
    </div>

    <!-- Biznesini Paylaş Forması Bölməsi -->
    <section id="share-form-section" class="flex-grow flex items-center justify-center py-20 px-4 bg-gray-800" style="padding-top: 8rem;">
        <div class="max-w-3xl w-full gradient-form-bg rounded-lg shadow-2xl p-8 md:p-12 border border-green-700 hover-grow">
            <h2 class="text-4xl font-bold text-center mb-8 text-white">Biznesini Paylaş</h2>
            <p class="text-center text-gray-200 mb-8">
                Biznesinizi geniş kütləyə çatdırmaq üçün aşağıdakı formu doldurun. Məlumatlarınız yoxlandıqdan sonra AxtarGet botunda və bu səhifədə görünəcək.
            </p>

            <form id="business-share-form" class="space-y-6">
                <div>
                    <label for="business-name" class="block text-white text-lg font-semibold mb-2">Biznes Adı <span class="text-red-400">*</span></label>
                    <input type="text" id="business-name" name="business-name" placeholder="Məsələn: Elektronika Dünyası" class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 border border-gray-600">
                </div>

                <div>
                    <label for="business-category" class="block text-white text-lg font-semibold mb-2">Kateqoriya <span class="text-red-400">*</span></label>
                    <select id="business-category" name="business-category" class="w-full p-3 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-green-500 border border-gray-600">
                        <option value="">Kateqoriya Seçin</option>
                        <option value="Dərzi">Dərzi</option>
                        <option value="Bərbər">Bərbər</option>
                        <option value="Restoran">Restoran</option>
                        <option value="Elektronika">Elektronika</option>
                        <option value="Mebel">Mebel</option>
                        <option value="Təhsil">Təhsil</option>
                        <option value="Geyim">Geyim</option>
                        <option value="Avtomobil Xidmətləri">Avtomobil Xidmətləri</option>
                        <option value="Digər">Digər</option>
                    </select>
                </div>

                <div>
                    <label for="business-region" class="block text-white text-lg font-semibold mb-2">Bölgə <span class="text-red-400">*</span></label>
                    <select id="business-region" name="business-region" class="w-full p-3 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-green-500 border border-gray-600">
                        <option value="">Bölgə Seçin</option>
                        <option value="Bakı">Bakı</option>
                        <option value="Naxçıvan">Naxçıvan</option>
                        <option value="Gəncə">Gəncə</option>
                        <option value="Sumqayıt">Sumqayıt</option>
                        <option value="Lənkəran">Lənkəran</option>
                        <option value="Mingəçevir">Mingəçevir</option>
                        <option value="Şəki">Şəki</option>
                        <option value="Quba">Quba</option>
                        <option value="Şamaxı">Şamaxı</option>
                        <option value="Bərdə">Bərdə</option>
                        <option value="Xaçmaz">Xaçmaz</option>
                        <option value="Tovuz">Tovuz</option>
                        <option value="Digər">Digər</option>
                    </select>
                </div>

                <div>
                    <label for="business-about" class="block text-white text-lg font-semibold mb-2">Biznes Haqqında <span class="text-red-400">*</span></label>
                    <textarea id="business-about" name="business-about" rows="4" placeholder="Biznesiniz haqqında ətraflı məlumat yazın..." class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 border border-gray-600"></textarea>
                </div>

                <div>
                    <label for="contact-number" class="block text-white text-lg font-semibold mb-2">Əlaqə Nömrəsi <span class="text-red-400">*</span></label>
                    <input type="tel" id="contact-number" name="contact-number" placeholder="Məsələn: +994501234567" class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 border border-gray-600">
                </div>

                <div>
                    <label for="instagram-link" class="block text-white text-lg font-semibold mb-2">Instagram Linki (isteğe bağlı)</label>
                    <input type="url" id="instagram-link" name="instagram-link" placeholder="Məsələn: https://instagram.com/biznesiniz" class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 border border-gray-600">
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="terms-checkbox" name="terms-checkbox" class="h-5 w-5 text-green-600 rounded focus:ring-green-500 border-gray-300">
                    <label for="terms-checkbox" class="ml-2 text-gray-200 text-base">
                        <span class="text-red-400">*</span> Mən şərtləri qəbul edirəm: "Burada paylaşılan heç bir şeyə məsuliyyət daşımırıq. Burada paylaşılan hər biznes Telegram botunda da paylaşılacaqdır."
                    </label>
                </div>

                <button type="submit" id="submit-business" class="w-full py-3 bg-green-600 text-white text-xl font-semibold rounded-lg shadow-lg hover:bg-green-700 transform hover-grow transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50">
                    Biznesi Paylaş
                </button>
            </form>
            <div id="loading-indicator" class="hidden mt-4 text-center text-green-400">
                <i class="fas fa-spinner fa-spin mr-2"></i> Məlumatlarınız göndərilir...
            </div>
            <p class="text-sm text-gray-400 text-center mt-6">
                <span class="text-red-400">*</span> İşarəsi olan sahələr məcburidir.
            </p>
        </div>
    </section>

    <!-- İstifdəçi Paylaşımları Bölməsi (Instagram-a bənzər feed) -->
    <section id="user-posts-section" class="section-padding bg-gray-900">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-4xl font-bold text-center mb-12 text-green-400">İstifadəçi Paylaşımları</h2>
            <div class="text-center mb-8">
                <button id="add-your-business-btn" class="inline-flex items-center px-6 py-3 bg-green-600 text-white text-lg font-semibold rounded-full shadow-lg hover:bg-green-700 transform hover-grow transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50">
                    <i class="fas fa-plus-circle mr-2"></i> Sən də Əlavə Et
                </button>
            </div>
            <div id="business-posts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Biznes paylaşımları buraya dinamik olaraq əlavə ediləcək -->
                <div class="business-card p-4 text-center">
                    <div class="business-card-content">
                        <h3 class="business-card-title">YÜKLƏNİR...</h3>
                        <p class="business-card-category-region">Kateqoriya: -, Bölgə: -</p>
                        <p class="business-card-about">Məlumatlar yüklənir, zəhmət olmasa gözləyin.</p>
                        <div class="business-card-contact">
                            <i class="fas fa-phone-alt"></i> Əlaqə: -
                        </div>
                        <div class="business-card-contact">
                            <i class="fab fa-instagram"></i> Instagram: -
                        </div>
                    </div>
                    <div class="interaction-bar">
                        <button class="interaction-button like-button"><i class="far fa-heart"></i> <span class="likes-count">0</span> Bəyənmə</button>
                        <button class="interaction-button comment-button"><i class="far fa-comment"></i> <span class="comments-count">0</span> Şərh</button>
                        <button class="interaction-button share-button"><i class="fas fa-share-alt"></i> Paylaş</button>
                    </div>
                </div>
            </div>
            <div id="no-businesses-message" class="hidden text-center text-gray-400 text-xl mt-8">
                Hələ heç bir biznes paylaşılmayıb. İlk siz olun!
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 py-8 text-center text-gray-400">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <p>&copy; 2025 AxtarGet Bot. Bütün hüquqlar qorunur.</p>
            <p class="mt-2 text-sm">Created by Ibadulla Hasanov</p>
        </div>
    </footer>

    <div id="alert-container"></div>

    <!-- Comment Modal -->
    <div id="comment-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 class="text-2xl font-bold text-white mb-4">Şərhlər</h3>
            <div id="modal-comment-list" class="comment-list">
                <!-- Comments will be loaded here -->
            </div>
            <div class="flex mt-4 gap-2">
                <input type="text" id="comment-input" placeholder="Şərhinizi yazın..." class="flex-grow p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-green-500 border border-gray-600">
                <button id="post-comment-btn" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition-colors duration-300">Göndər</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal (İndi yalnız Giriş Üçündür) -->
    <div id="auth-modal" class="modal hidden">
        <div class="auth-modal-content">
            <span class="close-button" id="close-auth-modal">&times;</span>
            <h3 class="text-2xl font-bold text-white mb-6 text-center">Daxil Ol</h3>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-white text-lg font-semibold mb-2">E-poçt</label>
                    <input type="email" id="auth-email" placeholder="E-poçt ünvanınız" class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 border border-gray-600">
                </div>
                <div>
                    <label for="auth-password" class="block text-white text-lg font-semibold mb-2">Şifrə</label>
                    <input type="password" id="auth-password" placeholder="Şifrəniz" class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 border border-gray-600">
                </div>
                <button type="submit" id="login-button" class="w-full py-3 bg-green-600 text-white text-xl font-semibold rounded-lg shadow-lg hover:bg-green-700 transform hover-grow transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50">
                    Daxil Ol
                </button>
                <p class="text-center text-gray-400 mt-4">
                    Hesabınız yoxdur? <a href="register.html" class="link-text">Qeydiyyatdan Keçin</a>
                </p>
                <div id="auth-loading-indicator" class="hidden mt-4 text-center text-green-400">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Yüklənir...
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; // signOut əlavə edildi
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Firebase konfiqurasiyası - provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyBEFLX4Uy4jTzoSyEdzYzOSEd2lqn8ifbE",
            authDomain: "axtargetbotwebsite.firebaseapp.com",
            projectId: "axtargetbotwebsite",
            storageBucket: "axtargetbotwebsite.firebasestorage.app", 
            messagingSenderId: "808698399196",
            appId: "1:808698399196:web:61b6be0721b94f24c3a719",
            measurementId: "G-VLWZG4Q5TD"
        };
        const firebaseProjectId = firebaseConfig.projectId; // Firebase Project ID-ni istifadə edin

        // Firebase-i Başlat
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Log to confirm Firebase app initialization
        if (app) {
            console.log("Firebase App successfully loaded!");
        } else {
            console.error("Firebase App failed to load!");
        }


        let currentUserId = null; // Authenticated user's ID
        let currentUserName = "Anonim İstifadəçi"; // Default username

        // DOM Elements
        const businessShareForm = document.getElementById('business-share-form');
        const businessNameInput = document.getElementById('business-name');
        const businessCategorySelect = document.getElementById('business-category');
        const businessRegionSelect = document.getElementById('business-region');
        const businessAboutTextarea = document.getElementById('business-about');
        const contactNumberInput = document.getElementById('contact-number');
        const instagramLinkInput = document.getElementById('instagram-link');
        const termsCheckbox = document.getElementById('terms-checkbox');
        const submitButton = document.getElementById('submit-business');
        const loadingIndicator = document.getElementById('loading-indicator');
        const alertContainer = document.getElementById('alert-container');
        const businessPostsContainer = document.getElementById('business-posts-container');
        const noBusinessesMessage = document.getElementById('no-businesses-message');
        const addYourBusinessBtn = document.getElementById('add-your-business-btn');

        // Comment Modal Elements
        const commentModal = document.getElementById('comment-modal');
        const closeModalButton = commentModal.querySelector('.close-button');
        const modalCommentList = document.getElementById('modal-comment-list');
        const commentInput = document.getElementById('comment-input');
        const postCommentBtn = document.getElementById('post-comment-btn');
        let currentBusinessId = null; // Currently viewed business for comments

        // Auth Modal Elements
        const authModal = document.getElementById('auth-modal');
        const closeAuthModalButton = document.getElementById('close-auth-modal');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const loginButton = document.getElementById('login-button');
        const authLoadingIndicator = document.getElementById('auth-loading-indicator');

        // Profile Elements
        const profileInitials = document.getElementById('profile-initials');
        const userProfileDropdown = document.getElementById('user-profile-dropdown');
        const dropdownUsername = document.getElementById('dropdown-username');
        const dropdownEmail = document.getElementById('dropdown-email');
        const logoutButton = document.getElementById('logout-button');


        // Custom Alert Function (instead of alert())
        function showAlert(message, type = 'error') {
            const alertBox = document.createElement('div');
            alertBox.className = `alert-message ${type} fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white p-3 rounded-lg shadow-md z-50`;
            alertBox.textContent = message;
            
            const existingAlerts = document.querySelectorAll('.alert-message');
            existingAlerts.forEach(alert => alert.remove());

            if (type === 'success') {
                alertBox.classList.remove('bg-red-600');
                alertBox.classList.add('bg-green-600');
            }
            alertContainer.appendChild(alertBox);
            setTimeout(() => {
                alertBox.classList.add('show');
            }, 10); // Small delay to trigger transition
            setTimeout(() => {
                alertBox.classList.remove('show');
                alertBox.addEventListener('transitionend', () => alertBox.remove(), { once: true });
            }, 3000); // Hide after 3 seconds
        }

        // Authentication State Change Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                // İstifadəçi adını və e-poçtunu yalnız anonim olmayan istifadəçilər üçün yüklə
                if (!user.isAnonymous) {
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        currentUserName = userDocSnap.data().username;
                    } else {
                        // Əgər user sənədi yoxdursa, UID-dən istifadəçi adı yarat (daha aydın olmaq üçün)
                        currentUserName = "İstifadəçi " + user.uid.substring(0, 6); // UID-nin ilk 6 simvolu
                    }
                    // Update profile initials and show
                    profileInitials.textContent = currentUserName.charAt(0).toUpperCase();
                    profileInitials.classList.remove('hidden');
                    dropdownUsername.textContent = currentUserName;
                    dropdownEmail.textContent = user.email;
                } else {
                    currentUserName = "Anonim İstifadəçi";
                    profileInitials.classList.add('hidden'); // Hide for anonymous users
                }
                
                console.log("Firebase Authentication successful. User ID:", currentUserId, "Username:", currentUserName);
                // Load businesses after successful authentication
                loadBusinesses();
            } else {
                console.log("Firebase Authentication failed. Attempting anonymous sign-in.");
                currentUserId = null;
                currentUserName = "Anonim İstifadəçi";
                profileInitials.classList.add('hidden'); // Hide for logged out users
                userProfileDropdown.classList.add('hidden'); // Hide dropdown if user logs out
                // If no user is signed in, attempt anonymous sign-in
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in error:", error);
                    showAlert("Anonim girişdə xəta baş verdi. Zəhmət olmasa, səhifəni yeniləyin.", 'error');
                });
            }
        });

        // Open/Close Auth Modal
        function openAuthModal() {
            authModal.classList.remove('hidden');
        }

        function closeAuthModal() {
            authModal.classList.add('hidden');
            authEmailInput.value = '';
            authPasswordInput.value = '';
            authLoadingIndicator.classList.add('hidden');
            loginButton.disabled = false;
        }

        closeAuthModalButton.addEventListener('click', closeAuthModal);
        authModal.addEventListener('click', (event) => {
            if (event.target === authModal) {
                closeAuthModal();
            }
        });

        // Login Button Click Handler
        loginButton.addEventListener('click', async (e) => {
            e.preventDefault(); // Prevent form submission

            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();

            if (!email || !password) {
                showAlert("E-poçt və şifrə boş ola bilməz.", 'error');
                return;
            }

            authLoadingIndicator.classList.remove('hidden');
            loginButton.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showAlert("Uğurla daxil oldunuz!", 'success');
                console.log("Giriş uğurludur. Modalı bağlayır və səhifəni yeniləyir.");
                // Modalı dərhal bağla
                closeAuthModal(); 
                // Səhifəni qısa gecikmədən sonra yeniləyin ki, Firebase statusu yenilənsin
                setTimeout(() => { 
                    window.location.reload(); 
                }, 500); // 0.5 saniyəlik gecikmə
                
            } catch (error) {
                console.error("Giriş xətası:", error); // Check console for more details on the error
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                    showAlert("Yanlış e-poçt və ya şifrə. Zəhmət olmasa, düzgün daxil edin.", 'error');
                } else {
                    showAlert("Giriş zamanı xəta baş verdi: " + error.message, 'error');
                }
            } finally {
                authLoadingIndicator.classList.add('hidden');
                loginButton.disabled = false;
            }
        });


        // Business Share Form Submission Handler
        businessShareForm.addEventListener('submit', async function(e) {
            e.preventDefault(); // Prevent page reload

            // Proceed only if user is authenticated (anonymous is okay for viewing, but not for sharing)
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                openAuthModal();
                showAlert("Biznes paylaşmaq üçün daxil olmalısınız.", 'error');
                return;
            }

            // Validate form fields
            const businessName = businessNameInput.value.trim();
            const businessCategory = businessCategorySelect.value;
            const businessRegion = businessRegionSelect.value;
            const businessAbout = businessAboutTextarea.value.trim();
            const contactNumber = contactNumberInput.value.trim();
            const instagramLink = instagramLinkInput.value.trim();
            const termsAccepted = termsCheckbox.checked;

            if (!businessName || !businessCategory || !businessRegion || !businessAbout || !contactNumber) {
                showAlert("Please fill in all required fields.", 'error');
                return;
            }

            if (!termsAccepted) {
                showAlert("You must accept the terms to share your business.", 'error');
                return;
            }

            // Show loading indicator and disable button
            loadingIndicator.classList.remove('hidden');
            submitButton.disabled = true;
            submitButton.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                // Add business data to Firestore
                await addDoc(collection(db, `artifacts/${firebaseProjectId}/public/data/businesses`), {
                    userId: currentUserId,
                    userName: currentUserName, // İstifadəçi adı əlavə edildi
                    businessName: businessName,
                    businessCategory: businessCategory,
                    businessRegion: businessRegion,
                    businessAbout: businessAbout,
                    contactNumber: contactNumber,
                    instagramLink: instagramLink,
                    likes: [], // List of user IDs who liked
                    comments: [], // List of comments
                    createdAt: serverTimestamp() // Timestamp of creation
                });

                showAlert("Your business has been successfully submitted! It will appear on the bot and this page after review.", 'success');
                businessShareForm.reset(); // Clear the form
                termsCheckbox.checked = false; // Uncheck checkbox

            } catch (error) {
                console.error("Business submission error:", error);
                showAlert("An error occurred while sharing your business. Please try again.", 'error');
            } finally {
                // Hide loading indicator and enable button
                loadingIndicator.classList.add('hidden');
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        // Load and Display Businesses from Firestore
        function loadBusinesses() {
            const businessesColRef = collection(db, `artifacts/${firebaseProjectId}/public/data/businesses`);
            const q = query(businessesColRef);

            onSnapshot(q, (snapshot) => {
                businessPostsContainer.innerHTML = ''; // Clear existing content
                const businesses = [];
                snapshot.forEach((doc) => {
                    businesses.push({ id: doc.id, ...doc.data() });
                });

                if (businesses.length === 0) {
                    noBusinessesMessage.classList.remove('hidden');
                } else {
                    noBusinessesMessage.classList.add('hidden');
                    businesses.forEach(business => {
                        const businessCard = document.createElement('div');
                        businessCard.className = 'business-card';
                        businessCard.innerHTML = `
                            <div class="business-card-content">
                                <h3 class="business-card-title">${business.businessName.toUpperCase()}</h3>
                                <p class="business-card-category-region">Kateqoriya: ${business.businessCategory} | Bölgə: ${business.businessRegion}</p>
                                <p class="business-card-about">${business.businessAbout}</p>
                                <div class="business-card-contact">
                                    <i class="fas fa-phone-alt"></i> Əlaqə: <a href="tel:${business.contactNumber}" class="text-white hover:text-green-400">${business.contactNumber}</a>
                                </div>
                                ${business.instagramLink ? `
                                <div class="business-card-contact">
                                    <i class="fab fa-instagram"></i> Instagram: <a href="${business.instagramLink}" target="_blank" class="text-white hover:text-green-400">${business.instagramLink.split('/').pop() || 'Link'}</a>
                                </div>` : ''}
                            </div>
                            <div class="interaction-bar">
                                <button class="interaction-button like-button ${business.likes && business.likes.includes(currentUserId) ? 'liked' : ''}" data-id="${business.id}">
                                    <i class="far fa-heart"></i> <span class="likes-count">${business.likes ? business.likes.length : 0}</span> Bəyənmə
                                </button>
                                <button class="interaction-button comment-button" data-id="${business.id}">
                                    <i class="far fa-comment"></i> <span class="comments-count">${business.comments ? business.comments.length : 0}</span> Şərh
                                </button>
                                <button class="interaction-button share-button" data-id="${business.id}" data-name="${business.businessName}" data-about="${business.businessAbout}">
                                    <i class="fas fa-share-alt"></i> Paylaş
                                </button>
                            </div>
                        `;
                        businessPostsContainer.appendChild(businessCard);
                    });
                    addInteractionListeners(); // Add listeners to new cards
                }
            }, (error) => {
                console.error("Error loading business data:", error);
                showAlert("Could not load business data.", 'error');
            });
        }

        // Event Listeners for Like, Comment, and Share Buttons
        function addInteractionListeners() {
            // Like Button
            businessPostsContainer.querySelectorAll('.like-button').forEach(button => {
                button.onclick = async (e) => {
                    // Only authenticated users can like
                    if (!auth.currentUser || auth.currentUser.isAnonymous) {
                        openAuthModal();
                        showAlert("Biznesi bəyənmək üçün daxil olmalısınız.", 'error');
                        return;
                    }

                    const businessId = e.currentTarget.dataset.id;
                    const businessRef = doc(db, `artifacts/${firebaseProjectId}/public/data/businesses`, businessId);
                    const docSnap = await getDoc(businessRef);
                    if (docSnap.exists()) {
                        const currentLikes = docSnap.data().likes || [];
                        if (currentLikes.includes(currentUserId)) {
                            // Already liked, so unlike
                            const newLikes = currentLikes.filter(uid => uid !== currentUserId);
                            await updateDoc(businessRef, { likes: newLikes });
                        } else {
                            // Not liked, so like
                            await updateDoc(businessRef, { likes: arrayUnion(currentUserId) });
                        }
                    }
                };
            });

            // Comment Button
            businessPostsContainer.querySelectorAll('.comment-button').forEach(button => {
                button.onclick = async (e) => {
                    // Only authenticated users can comment
                    if (!auth.currentUser || auth.currentUser.isAnonymous) {
                        openAuthModal();
                        showAlert("Şərh yazmaq üçün daxil olmalısınız.", 'error');
                        return;
                    }
                    currentBusinessId = e.currentTarget.dataset.id;
                    await loadComments(currentBusinessId);
                    commentModal.classList.remove('hidden');
                };
            });

            // Share Button
            businessPostsContainer.querySelectorAll('.share-button').forEach(button => {
                button.onclick = async (e) => {
                    const businessName = e.currentTarget.dataset.name;
                    const businessAbout = e.currentTarget.dataset.about;
                    const shareUrl = window.location.href; // Share current page URL

                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: `AxtarGet Bot: ${businessName}`,
                                text: `${businessName}: ${businessAbout}\nDiscover this business on AxtarGet Bot now!`,
                                url: shareUrl,
                            });
                            console.log('Successfully shared');
                        } catch (error) {
                            console.error('Sharing failed:', error);
                            showAlert('Sharing failed.', 'error');
                        }
                    } else {
                        // Fallback if Web Share API is not supported
                        const shareText = `Discover ${businessName} on AxtarGet Bot! ${businessAbout}. More details: ${shareUrl}`;
                        prompt("You can copy and share this link:", shareText);
                    }
                };
            });
        }

        // Load Comments and Display in Modal
        async function loadComments(businessId) {
            modalCommentList.innerHTML = ''; // Clear comment list
            const businessRef = doc(db, `artifacts/${firebaseProjectId}/public/data/businesses`, businessId);
            const docSnap = await getDoc(businessRef);

            if (docSnap.exists()) {
                const comments = docSnap.data().comments || [];
                if (comments.length === 0) {
                    modalCommentList.innerHTML = '<p class="text-gray-400 text-center">Hələ heç bir şərh yoxdur.</p>';
                } else {
                    comments.forEach(comment => {
                        const commentItem = document.createElement('div');
                        commentItem.className = 'comment-item';
                        const timestampDate = comment.timestamp ? new Date(comment.timestamp.toDate()) : new Date(); // Fallback for timestamp
                        commentItem.innerHTML = `
                            <p><span class="comment-author">${comment.author || 'Anonim İstifadəçi'}:</span> <span class="comment-text">${comment.text}</span></p>
                            <p class="comment-timestamp">${timestampDate.toLocaleString()}</p>
                        `;
                        modalCommentList.appendChild(commentItem);
                    });
                }
            } else {
                modalCommentList.innerHTML = '<p class="text-red-400 text-center">Biznes tapılmadı.</p>';
            }
        }

        // Post Comment
        postCommentBtn.addEventListener('click', async () => {
            const commentText = commentInput.value.trim();
            if (!commentText) {
                showAlert("Please write your comment.", 'error');
                return;
            }

            if (!currentBusinessId) {
                showAlert("No business selected to add comment.", 'error');
                return;
            }

            // Only authenticated users can comment
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                showAlert("Şərh yazmaq üçün daxil olmalısınız.", 'error');
                commentModal.classList.add('hidden'); // Close modal
                openAuthModal(); // Open authentication modal
                return;
            }

            try {
                // Log currentUserName before posting to debug
                console.log("Posting comment with currentUserName:", currentUserName);

                const businessRef = doc(db, `artifacts/${firebaseProjectId}/public/data/businesses`, currentBusinessId);
                await updateDoc(businessRef, {
                    comments: arrayUnion({
                        author: currentUserName, // İstifadəçi adı istifadə edildi
                        text: commentText,
                        timestamp: serverTimestamp()
                    })
                });
                commentInput.value = ''; // Clear input
                showAlert("Comment successfully added!", 'success');
                // Comments will automatically refresh due to onSnapshot.
            } catch (error) {
                console.error("Error adding comment:", error);
                showAlert("An error occurred while adding the comment.", 'error');
            }
        });


        // Close Modal Events
        closeModalButton.addEventListener('click', () => {
            commentModal.classList.add('hidden');
        });

        window.addEventListener('click', (event) => {
            if (event.target === commentModal) {
                commentModal.classList.add('hidden');
            }
        });


        // "Add Your Business" button click (for scrolling to form)
        addYourBusinessBtn.addEventListener('click', () => {
            document.getElementById('share-form-section').scrollIntoView({
                behavior: 'smooth'
            });
        });

        // Profile Initials click to toggle dropdown
        profileInitials.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent document click from immediately closing
            userProfileDropdown.classList.toggle('hidden');
        });

        // Logout Button click
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showAlert("Uğurla çıxış etdiniz!", 'success');
                userProfileDropdown.classList.add('hidden'); // Hide dropdown
                window.location.reload(); // Reload page to reflect logout state
            } catch (error) {
                console.error("Çıxış zamanı xəta:", error);
                showAlert("Çıxış zamanı xəta baş verdi.", 'error');
            }
        });

        // Close dropdown if clicked outside
        document.addEventListener('click', (event) => {
            if (!userProfileDropdown.contains(event.target) && !profileInitials.contains(event.target)) {
                userProfileDropdown.classList.add('hidden');
            }
        });


        // Smooth scrolling for header navigation links (mainly for returning to main page sections)
        document.querySelectorAll('a[href^="index.html#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                // Check if we are on the index.html page
                if (window.location.pathname === '/' || window.location.pathname === '/index.html') {
                    const targetId = this.getAttribute('href').split('#')[1];
                    document.getElementById(targetId).scrollIntoView({
                        behavior: 'smooth'
                    });
                } else {
                    // Redirect to index.html with hash
                    window.location.href = this.getAttribute('href');
                }
                document.getElementById('mobile-menu').classList.add('hidden');
            });
        });
    </script>
</body>
</html>
