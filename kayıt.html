<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6197631175303658"
     crossorigin="anonymous"></script>
    
    <title>Axtarget Recorder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #0f172a; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; font-family: sans-serif; }
        .webcam-preview { width: 150px; border-radius: 8px; position: absolute; bottom: 10px; right: 10px; transform: scaleX(-1); border: 2px solid #3b82f6; }
        .quality-btn.active { background: #3b82f6; }
    </style>
</head>
<body>

    <div class="w-full max-w-lg p-6 bg-slate-800 rounded-xl shadow-xl">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold">Axtarget Recorder</h1>
            <div id="status" class="hidden text-red-500 font-bold animate-pulse">● REC <span id="timer">00:00</span></div>
        </div>

        <div class="relative aspect-video bg-black rounded-lg mb-4 overflow-hidden">
            <video id="preview" class="w-full h-full hidden" controls></video>
            <div id="blank" class="h-full flex items-center justify-center text-slate-500 text-sm italic">Video yoxdur</div>
            <video id="webcam" class="webcam-preview hidden" autoplay muted></video>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-4">
            <div class="flex flex-col gap-2">
                <label class="text-xs text-slate-400">Keyfiyyət</label>
                <div class="flex gap-1">
                    <button class="quality-btn px-2 py-1 bg-slate-700 rounded text-xs active" data-val="1080">1080p</button>
                    <button class="quality-btn px-2 py-1 bg-slate-700 rounded text-xs" data-val="720">720p</button>
                </div>
            </div>
            <div class="flex flex-col gap-2">
                <label class="text-xs text-slate-400">Seçimlər</label>
                <div class="flex gap-4 items-center h-full">
                    <label class="text-xs flex items-center gap-1"><input type="checkbox" id="cam-check"> Kamera</label>
                    <label class="text-xs flex items-center gap-1"><input type="checkbox" id="mic-check" checked> Mik</label>
                </div>
            </div>
        </div>

        <div class="flex gap-2">
            <button id="record-btn" class="flex-1 bg-blue-600 p-3 rounded font-bold">Qeydə Başla</button>
            <button id="stop-btn" class="hidden flex-1 bg-red-600 p-3 rounded font-bold">Durdur</button>
        </div>

        <div id="result-btns" class="hidden mt-4 flex gap-2">
            <button id="download-btn" class="flex-1 bg-green-600 p-2 rounded text-sm font-bold">Yüklə</button>
            <button id="delete-btn" class="bg-slate-700 p-2 rounded text-sm"><i class="fas fa-trash"></i></button>
        </div>
    </div>

    <canvas id="mixer-canvas" style="display:none;"></canvas>

    <script>
        let mediaRecorder, chunks = [], timer, start, mStream, wStream, quality = 1080;
        const mixerCanvas = document.getElementById('mixer-canvas');
        const mixerCtx = mixerCanvas.getContext('2d');
        const vWebcam = document.getElementById('webcam'), vScreen = document.createElement('video');

        document.querySelectorAll('.quality-btn').forEach(b => {
            b.onclick = () => {
                document.querySelectorAll('.quality-btn').forEach(x => x.classList.remove('active'));
                b.classList.add('active');
                quality = parseInt(b.dataset.val);
            }
        });

        document.getElementById('cam-check').onchange = async (e) => {
            if (e.target.checked) {
                try {
                    wStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    vWebcam.srcObject = wStream;
                    vWebcam.classList.remove('hidden');
                } catch { e.target.checked = false; }
            } else {
                if (wStream) wStream.getTracks().forEach(t => t.stop());
                vWebcam.classList.add('hidden');
            }
        };

        function drawFrame() {
            mixerCtx.drawImage(vScreen, 0, 0, mixerCanvas.width, mixerCanvas.height);
            if (document.getElementById('cam-check').checked && vWebcam.readyState === 4) {
                const cw = mixerCanvas.width * 0.2;
                const ch = (vWebcam.videoHeight / vWebcam.videoWidth) * cw;
                mixerCtx.save();
                mixerCtx.translate(mixerCanvas.width - cw - 20 + cw, mixerCanvas.height - ch - 20);
                mixerCtx.scale(-1, 1);
                mixerCtx.drawImage(vWebcam, 0, 0, cw, ch);
                mixerCtx.restore();
            }
        }

        document.getElementById('record-btn').onclick = async () => {
            try {
                const sStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { width: { ideal: 1920 }, height: { ideal: quality } },
                    audio: true
                });
                vScreen.srcObject = sStream;
                vScreen.play();

                const settings = sStream.getVideoTracks()[0].getSettings();
                mixerCanvas.width = settings.width;
                mixerCanvas.height = settings.height;

                const interval = setInterval(drawFrame, 1000/30);
                const mixedStream = mixerCanvas.captureStream(30);
                
                let tracks = [...mixedStream.getVideoTracks()];
                if (sStream.getAudioTracks().length > 0) tracks.push(sStream.getAudioTracks()[0]);
                if (document.getElementById('mic-check').checked) {
                    const m = await navigator.mediaDevices.getUserMedia({ audio: true });
                    tracks.push(m.getAudioTracks()[0]);
                }

                mediaRecorder = new MediaRecorder(new MediaStream(tracks), { 
                    mimeType: 'video/webm;codecs=vp9', 
                    videoBitsPerSecond: 8000000 
                });
                
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    clearInterval(interval);
                    const b = new Blob(chunks, { type: 'video/webm' });
                    document.getElementById('preview').src = URL.createObjectURL(b);
                    document.getElementById('preview').classList.remove('hidden');
                    document.getElementById('blank').classList.add('hidden');
                    document.getElementById('result-btns').classList.remove('hidden');
                    document.getElementById('status').classList.add('hidden');
                    document.getElementById('stop-btn').classList.add('hidden');
                    document.getElementById('record-btn').classList.remove('hidden');
                    clearInterval(timer);
                    sStream.getTracks().forEach(t => t.stop());
                };

                chunks = [];
                mediaRecorder.start();
                document.getElementById('record-btn').classList.add('hidden');
                document.getElementById('stop-btn').classList.remove('hidden');
                document.getElementById('status').classList.remove('hidden');
                
                start = Date.now();
                timer = setInterval(() => {
                    const d = new Date(Date.now() - start);
                    document.getElementById('timer').textContent = d.toISOString().substr(14, 5);
                }, 1000);

                sStream.getVideoTracks()[0].onended = () => mediaRecorder.stop();
            } catch (err) {}
        };

        document.getElementById('stop-btn').onclick = () => mediaRecorder.stop();
        document.getElementById('download-btn').onclick = () => {
            const a = document.createElement('a');
            a.href = document.getElementById('preview').src;
            a.download = 'record.webm';
            a.click();
        };
        document.getElementById('delete-btn').onclick = () => location.reload();
    </script>
</body>
</html>
