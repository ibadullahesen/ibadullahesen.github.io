<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Axtarget.xyz - Şəkil Redaktə</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            touch-action: manipulation;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
        }
        .card {
            background-color: #2d3748;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .file-label {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 14px rgba(66, 153, 225, 0.3);
        }
        .canvas-container {
            position: relative;
            margin-top: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            width: 100%;
            height: auto;
            max-height: 70vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: linear-gradient(45deg, #333 25%, transparent 25%), linear-gradient(-45deg, #333 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #333 75%), linear-gradient(-45deg, transparent 75%, #333 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            overflow: hidden;
        }
        canvas {
            display: block;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
            cursor: crosshair;
            touch-action: none;
        }
        .message-box {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4a5568;
            color: #fff;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            text-align: center;
        }
        .tab-button {
            background-color: #4a5568;
            color: #e2e8f0;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
        }
        .tab-button:hover {
            background-color: #6a717f;
        }
        .tab-button.active:hover {
            background-color: #2563eb;
        }
        .tool-panel {
            display: none;
        }
        .tool-panel.active {
            display: flex;
            flex-direction: column;
        }
        .custom-select {
            position: relative;
            width: 100%;
            max-width: 300px;
        }
        .select-header {
            background-color: #4a5568;
            color: #e2e8f0;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .select-header:hover {
            background-color: #6a717f;
        }
        .select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #2d3748;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 250px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }
        .select-dropdown.open {
            display: block;
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dropdown-item:hover {
            background-color: #4a5568;
        }
        .dropdown-item.active {
            background-color: #3b82f6;
            color: white;
        }
        .dropdown-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-right: 1rem;
            position: relative;
        }
        .watermark {
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 8px;
            color: #e2e8f0;
            background-color: rgba(45, 55, 72, 0.7);
            padding: 2px 4px;
            border-radius: 2px;
            pointer-events: none;
            opacity: 0.8;
        }
        .resolution-options {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        .resolution-options input[type="radio"] {
            display: none;
        }
        .resolution-options label {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            background-color: #4a5568;
            color: #e2e8f0;
            transition: all 0.3s ease;
        }
        .resolution-options input[type="radio"]:checked + label {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .tool-option-btn {
            background-color: #4a5568;
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .tool-option-btn.active {
            background-color: #22c55e;
            color: white;
            box-shadow: 0 4px 14px rgba(34, 197, 94, 0.3);
        }
        .tool-option-btn:hover {
            background-color: #6a717f;
        }
        .tool-option-btn.active:hover {
            background-color: #16a34a;
        }
        .text-controls-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .color-picker-wrapper {
            position: relative;
            display: inline-block;
        }
        .color-display {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        .color-display:hover {
            border-color: #3b82f6;
        }
        #textColorPicker, #textBgColorPicker, #textShadowColorPicker {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .tone-sliders {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 300px;
        }
        .tone-sliders label {
            display: block;
            text-align: center;
            color: #e2e8f0;
        }
        .color-picker-container {
            position: relative;
            margin-top: 1rem;
        }
        .color-preview {
            width: 100%;
            height: 40px;
            border-radius: 8px;
            margin-top: 0.5rem;
            border: 2px solid #4a5568;
        }
        .color-picker-input {
            width: 100%;
            padding: 0.5rem;
            border-radius: 8px;
            background-color: #4a5568;
            color: white;
            border: none;
            margin-top: 0.5rem;
        }
        @media (max-width: 640px) {
            .container {
                padding: 0.5rem;
            }
            .card {
                padding: 1rem;
            }
            .canvas-container {
                flex-direction: column;
                max-height: 50vh;
            }
            .canvas-container #imageCanvas {
                order: -1;
            }
            .resolution-options {
                flex-wrap: wrap;
            }
            .text-controls-grid {
                grid-template-columns: 1fr;
            }
            .tab-button {
                padding: 0.5rem 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased flex flex-col min-h-screen">
    <div class="message-box" id="messageBox" role="alert"></div>

    <header class="w-full py-4 px-2">
        <div class="container flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-blue-400">Axtarget.xyz</h1>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center p-2">
        <div class="w-full card">
            <h2 class="text-xl font-bold text-center mb-2">Şəkilə Film Filteri Tətbiq Et</h2>
            <p class="text-center text-gray-400 text-sm mb-4">Şəkilinizi yükləyin və onu redaktə edin.</p>

            <div class="flex flex-col items-center justify-center gap-4">
                <label for="imageUpload" class="file-label px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-full shadow-lg transition-colors duration-300">
                    Şəkil Yüklə
                </label>
                <input type="file" id="imageUpload" accept="image/png,image/jpeg,image/webp,image/gif" class="hidden">

                <div class="canvas-container hidden">
                    <canvas id="imageCanvas" aria-label="Şəkil redaktə sahəsi"></canvas>
                    <button id="undoBtn" class="absolute top-2 left-2 z-10 p-2 rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors hidden" aria-label="Geri al">
                        <i class="fas fa-undo"></i> Geri al
                    </button>
                </div>
                
                <div id="controls" class="hidden w-full flex flex-col items-center gap-4 mt-4">
                    <div class="flex gap-4 justify-center w-full max-w-lg flex-wrap">
                        <button id="filterTab" class="tab-button active" aria-label="Filtrlər paneli">
                            <i class="fas fa-palette"></i> Filtrlər
                        </button>
                        <button id="textTab" class="tab-button" aria-label="Mətn paneli">
                            <i class="fas fa-font"></i> Mətn
                        </button>
                        <button id="bgRemoveTab" class="tab-button" aria-label="Fon silmə paneli">
                            <i class="fas fa-eraser"></i> Fon Silmə
                        </button>
                        <button id="toneTab" class="tab-button" aria-label="Ton düzəlişləri paneli">
                            <i class="fas fa-adjust"></i> Ton
                        </button>
                    </div>

                    <!-- Filter Tool Panel -->
                    <div id="filterPanel" class="tool-panel active w-full flex flex-col items-center gap-4">
                        <div class="w-full flex flex-col items-center gap-2">
                            <p class="text-center text-gray-400">Normal Filtrlər:</p>
                            <div id="normal-select-container" class="custom-select">
                                <div class="select-header" id="normalSelectHeader" role="button" aria-expanded="false" aria-controls="normalFilterDropdown">
                                    <span id="normalSelectedFilterText">Orijinal</span>
                                    <span>&#9660;</span>
                                </div>
                                <div class="select-dropdown" id="normalFilterDropdown"></div>
                            </div>
                        </div>

                        <div class="w-full flex flex-col items-center gap-2 mt-4">
                            <p class="text-center text-gray-400">Qara-Ağ Filtrlər:</p>
                            <div id="bw-select-container" class="custom-select">
                                <div class="select-header" id="bwSelectHeader" role="button" aria-expanded="false" aria-controls="bwFilterDropdown">
                                    <span id="bwSelectedFilterText">Seçin</span>
                                    <span>&#9660;</span>
                                </div>
                                <div class="select-dropdown" id="bwFilterDropdown"></div>
                            </div>
                        </div>

                        <div class="w-full flex flex-col items-center gap-2 mt-4">
                            <p class="text-center text-gray-400">Premium Filtrlər:</p>
                            <div id="premium-select-container" class="custom-select">
                                <div class="select-header" id="premiumSelectHeader" role="button" aria-expanded="false" aria-controls="premiumFilterDropdown">
                                    <span id="premiumSelectedFilterText">Seçin</span>
                                    <span>&#9660;</span>
                                </div>
                                <div class="select-dropdown" id="premiumFilterDropdown"></div>
                            </div>
                        </div>
                        
                        <div id="intensity-control" class="w-full max-w-md mt-4">
                            <label for="intensitySlider" class="block text-center text-gray-400">Effektin gücü:</label>
                            <input type="range" id="intensitySlider" min="0" max="100" value="100" class="w-full mt-2 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer" aria-label="Effektin gücü">
                        </div>
                    </div>

                    <!-- Text Tool Panel -->
                    <div id="textPanel" class="tool-panel w-full flex-col items-center gap-4 hidden">
                        <div class="w-full max-w-md flex flex-col gap-4">
                            <input type="text" id="textInput" placeholder="Mətn daxil edin" class="w-full px-4 py-2 rounded-full bg-gray-700 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Mətn daxil edin">
                            
                            <div class="text-controls-grid">
                                <div>
                                    <label for="textSize" class="block text-gray-400">Ölçü:</label>
                                    <input type="range" id="textSize" value="48" min="10" max="200" class="w-full px-4 py-2 rounded-full bg-gray-700 text-gray-200 mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Mətn ölçüsü">
                                </div>
                                <div>
                                    <label for="textFamily" class="block text-gray-400">Font:</label>
                                    <select id="textFamily" class="w-full px-4 py-2 rounded-full bg-gray-700 text-gray-200 mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Mətn fontu">
                                        <option value="Inter">Inter</option>
                                        <option value="Arial">Arial</option>
                                        <option value="Verdana">Verdana</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                        <option value="Courier New">Courier New</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="textColorPicker" class="block text-gray-400">Rəng:</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <div class="color-picker-wrapper">
                                            <div id="textColorDisplay" class="color-display" style="background-color: #ffffff;"></div>
                                            <input type="color" id="textColorPicker" value="#ffffff" aria-label="Mətn rəngi">
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="textBgColorPicker" class="block text-gray-400">Arxa Fon Rəngi:</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <div class="color-picker-wrapper">
                                            <div id="textBgColorDisplay" class="color-display" style="background-color: transparent;"></div>
                                            <input type="color" id="textBgColorPicker" value="#00000000" aria-label="Mətn arxa fon rəngi">
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="textShadowColorPicker" class="block text-gray-400">Kölgə Rəngi:</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <div class="color-picker-wrapper">
                                            <div id="textShadowColorDisplay" class="color-display" style="background-color: #000000;"></div>
                                            <input type="color" id="textShadowColorPicker" value="#000000" aria-label="Mətn kölgə rəngi">
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="textShadowBlur" class="block text-gray-400">Kölgə Bulanıqlığı:</label>
                                    <input type="range" id="textShadowBlur" min="0" max="20" value="0" class="w-full mt-2 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer" aria-label="Kölgə bulanıqlığı">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Background Remove Tool Panel -->
                    <div id="bgRemovePanel" class="tool-panel w-full flex-col items-center gap-4 hidden">
                        <div class="flex flex-wrap gap-4 justify-center">
                            <button id="autoRemoveBtn" class="tool-option-btn" aria-label="Avtomatik fon silmə">
                                <i class="fas fa-magic"></i> Avtomatik Sil
                            </button>
                            <button id="colorRemoveBtn" class="tool-option-btn" aria-label="Rəngə görə fon silmə">
                                <i class="fas fa-fill-drip"></i> Rəngə Görə Sil
                            </button>
                            <button id="manualRemoveBtn" class="tool-option-btn" aria-label="Əl ilə fon silmə">
                                <i class="fas fa-brush"></i> Əl ilə Sil
                            </button>
                        </div>
                        <div id="manualControls" class="hidden w-full max-w-md mt-4 flex flex-col gap-4 items-center">
                            <label for="brushSize" class="block text-gray-400">Fırça ölçüsü:</label>
                            <input type="range" id="brushSize" min="5" max="100" value="20" class="w-full mt-2 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer" aria-label="Fırça ölçüsü">
                        </div>
                        <div id="colorPickerContainer" class="color-picker-container hidden">
                            <label for="colorToRemove" class="block text-gray-400">Silinəcək rəng:</label>
                            <input type="color" id="colorToRemove" value="#00ff00" class="color-picker-input">
                            <div id="colorPreview" class="color-preview" style="background-color: #00ff00;"></div>
                            <label for="colorTolerance" class="block text-gray-400 mt-2">Rəng toleransı:</label>
                            <input type="range" id="colorTolerance" min="0" max="100" value="30" class="w-full mt-2 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer" aria-label="Rəng toleransı">
                        </div>
                    </div>

                    <!-- Tone Adjustment Tool Panel -->
                    <div id="tonePanel" class="tool-panel w-full flex-col items-center gap-4 hidden">
                        <div class="tone-sliders">
                            <label for="brightnessSlider">İşıq:</label>
                            <input type="range" id="brightnessSlider" min="-100" max="100" value="0" aria-label="İşıq düzəlişi">
                            <label for="contrastSlider">Kontrast:</label>
                            <input type="range" id="contrastSlider" min="-100" max="100" value="0" aria-label="Kontrast düzəlişi">
                            <label for="saturationSlider">Doyğunluq:</label>
                            <input type="range" id="saturationSlider" min="-100" max="100" value="0" aria-label="Doyğunluq düzəlişi">
                            <label for="hueSlider">Ton:</label>
                            <input type="range" id="hueSlider" min="-180" max="180" value="0" aria-label="Ton düzəlişi">
                        </div>
                    </div>
                    
                    <p class="text-center text-gray-400 mt-4">Yükləmə keyfiyyətini seçin:</p>
                    <div class="resolution-options flex-wrap justify-center">
                        <input type="radio" id="resOriginal" name="resolution" value="original" checked>
                        <label for="resOriginal">Orijinal</label>
                        <input type="radio" id="res4k" name="resolution" value="4k">
                        <label for="res4k">4K</label>
                        <input type="radio" id="res8k" name="resolution" value="8k">
                        <label for="res8k">8K</label>
                    </div>
                    <p id="resolution-info" class="text-center text-gray-500 text-sm mt-2 hidden">
                        Keyfiyyəti artırdıqda fayl ölçüsünün də artacağını unutmayın.
                    </p>
                    
                    <button id="downloadBtn" class="w-full md:w-auto px-6 py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-full shadow-lg transition-colors duration-300" aria-label="Şəkili endir">
                        Şəkili Endir
                    </button>
                </div>
                <div id="loadingSpinner" class="hidden spinner mt-4">
                    <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </main>

    <footer class="w-full py-4 px-2">
        <div class="container text-center text-gray-500 text-sm">
            © 2025 Axtarget.xyz. Bütün hüquqlar qorunur.
        </div>
    </footer>

    <script>
        (function() {
            // DOM elements
            const elements = {
                fileInput: document.getElementById('imageUpload'),
                canvas: document.getElementById('imageCanvas'),
                canvasContainer: document.querySelector('.canvas-container'),
                downloadBtn: document.getElementById('downloadBtn'),
                controls: document.getElementById('controls'),
                loadingSpinner: document.getElementById('loadingSpinner'),
                messageBox: document.getElementById('messageBox'),
                undoBtn: document.getElementById('undoBtn'),
                tabButtons: {
                    filter: document.getElementById('filterTab'),
                    text: document.getElementById('textTab'),
                    bgRemove: document.getElementById('bgRemoveTab'),
                    tone: document.getElementById('toneTab')
                },
                toolPanels: {
                    filter: document.getElementById('filterPanel'),
                    text: document.getElementById('textPanel'),
                    bgRemove: document.getElementById('bgRemovePanel'),
                    tone: document.getElementById('tonePanel')
                },
                selectHeaders: {
                    normal: document.getElementById('normalSelectHeader'),
                    bw: document.getElementById('bwSelectHeader'),
                    premium: document.getElementById('premiumSelectHeader')
                },
                filterDropdowns: {
                    normal: document.getElementById('normalFilterDropdown'),
                    bw: document.getElementById('bwFilterDropdown'),
                    premium: document.getElementById('premiumFilterDropdown')
                },
                selectedFilterTexts: {
                    normal: document.getElementById('normalSelectedFilterText'),
                    bw: document.getElementById('bwSelectedFilterText'),
                    premium: document.getElementById('premiumSelectedFilterText')
                },
                intensitySlider: document.getElementById('intensitySlider'),
                intensityControl: document.getElementById('intensity-control'),
                resolutionOptions: document.getElementsByName('resolution'),
                resolutionInfo: document.getElementById('resolution-info'),
                textInput: document.getElementById('textInput'),
                textSizeInput: document.getElementById('textSize'),
                textFamilySelect: document.getElementById('textFamily'),
                textColorPicker: document.getElementById('textColorPicker'),
                textColorDisplay: document.getElementById('textColorDisplay'),
                textBgColorPicker: document.getElementById('textBgColorPicker'),
                textBgColorDisplay: document.getElementById('textBgColorDisplay'),
                textShadowColorPicker: document.getElementById('textShadowColorPicker'),
                textShadowColorDisplay: document.getElementById('textShadowColorDisplay'),
                textShadowBlur: document.getElementById('textShadowBlur'),
                autoRemoveBtn: document.getElementById('autoRemoveBtn'),
                colorRemoveBtn: document.getElementById('colorRemoveBtn'),
                manualRemoveBtn: document.getElementById('manualRemoveBtn'),
                manualControls: document.getElementById('manualControls'),
                brushSizeSlider: document.getElementById('brushSize'),
                colorPickerContainer: document.getElementById('colorPickerContainer'),
                colorToRemove: document.getElementById('colorToRemove'),
                colorPreview: document.getElementById('colorPreview'),
                colorTolerance: document.getElementById('colorTolerance'),
                brightnessSlider: document.getElementById('brightnessSlider'),
                contrastSlider: document.getElementById('contrastSlider'),
                saturationSlider: document.getElementById('saturationSlider'),
                hueSlider: document.getElementById('hueSlider')
            };

            // State variables
            let ctx = elements.canvas.getContext('2d');
            let originalImage = null;
            let currentImage = null;
            let currentFilter = 'Orijinal';
            let currentCategory = 'normal';
            let history = [];
            let texts = [];
            let canvasScale = 1;
            let isDraggingText = false;
            let isResizingText = false;
            let currentTextIndex = -1;
            let startDragX = 0;
            let startDragY = 0;
            let isDrawing = false;
            let currentTool = 'none';
            let toneAdjustments = { brightness: 0, contrast: 0, saturation: 0, hue: 0 };
            let lastX, lastY;
            let isErasing = false;
            let maskCanvas = null;
            let maskCtx = null;

            // Filter presets
            const filterPresets = {
                'Orijinal': 'none',
                'Dramatik': 'contrast(1.2) saturate(0.9) brightness(1.1) sepia(0.15)',
                'Canlı Rənglər': 'contrast(1.3) saturate(1.5) brightness(1.1)',
                'İsti Ton': 'sepia(0.3) saturate(1.2) brightness(1.1) contrast(1.1)',
                'Soyuq Ton': 'hue-rotate(180deg) contrast(1.1) saturate(1.2)',
                'Retro Film': 'sepia(0.8) contrast(1.1) saturate(0.8)',
                'Vintage': 'sepia(0.5) contrast(1.1) brightness(1.1) saturate(1.2)',
                'Qara-Ağ': 'grayscale(100%) contrast(1.2)',
                'Noir': 'grayscale(100%) contrast(1.5)',
                'Sinematik Mavi': 'saturate(1.2) contrast(1.1) brightness(1.1) hue-rotate(-20deg)',
                'Lomo': 'contrast(1.5) hue-rotate(-20deg) saturate(1.8)'
            };

            const groupedFilters = {
                normal: ['Orijinal', 'Dramatik', 'Canlı Rənglər', 'İsti Ton', 'Soyuq Ton', 'Retro Film', 'Vintage'],
                bw: ['Qara-Ağ', 'Noir'],
                premium: ['Sinematik Mavi', 'Lomo']
            };

            // Utility functions
            const showMessage = (message, duration = 3000) => {
                elements.messageBox.textContent = message;
                elements.messageBox.style.display = 'block';
                elements.messageBox.style.opacity = '1';
                setTimeout(() => {
                    elements.messageBox.style.opacity = '0';
                    setTimeout(() => {
                        elements.messageBox.style.display = 'none';
                    }, 500);
                }, duration);
            };

            const saveState = () => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = elements.canvas.width;
                tempCanvas.height = elements.canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                let filterStyle = getFilteredStyle(currentFilter, elements.intensitySlider.value);
                filterStyle = filterStyle === 'none' ? getToneStyle() : `${filterStyle} ${getToneStyle()}`;
                tempCtx.filter = filterStyle;
                tempCtx.drawImage(currentImage, 0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.filter = 'none';

                texts.forEach(t => {
                    tempCtx.font = `${t.size}px ${t.family}`;
                    tempCtx.fillStyle = t.color;
                    if (t.shadowBlur > 0) {
                        tempCtx.shadowColor = t.shadowColor;
                        tempCtx.shadowBlur = t.shadowBlur;
                        tempCtx.shadowOffsetX = 2;
                        tempCtx.shadowOffsetY = 2;
                    } else {
                        tempCtx.shadowColor = 'transparent';
                        tempCtx.shadowBlur = 0;
                    }
                    if (t.bgColor !== 'transparent') {
                        tempCtx.fillStyle = t.bgColor;
                        const metrics = tempCtx.measureText(t.text);
                        tempCtx.fillRect(t.x - 5, t.y - t.size + 5, metrics.width + 10, t.size);
                        tempCtx.fillStyle = t.color;
                    }
                    tempCtx.fillText(t.text, t.x, t.y);
                });

                history.push({ 
                    imageData: tempCanvas.toDataURL('image/png', 1.0), 
                    filter: currentFilter, 
                    category: currentCategory,
                    intensity: elements.intensitySlider.value, 
                    texts: JSON.stringify(texts),
                    tone: { ...toneAdjustments }
                });
                if (history.length > 10) history.shift();
                elements.undoBtn.classList.remove('hidden');
            };

            const undoLastAction = () => {
                if (history.length > 1) {
                    history.pop();
                    const lastState = history[history.length - 1];
                    currentFilter = lastState.filter;
                    currentCategory = lastState.category;
                    elements.intensitySlider.value = lastState.intensity;
                    texts = JSON.parse(lastState.texts);
                    toneAdjustments = lastState.tone;
                    updateToneSliders();
                    const img = new Image();
                    img.onload = () => {
                        currentImage = img;
                        elements.canvas.width = img.width;
                        elements.canvas.height = img.height;
                        redrawCanvas();
                        updateFilterUI(currentFilter, currentCategory);
                    };
                    img.src = lastState.imageData;
                } else if (history.length === 1) {
                    history = [];
                    resetCanvas();
                }
            };

            const resetCanvas = () => {
                if (originalImage) {
                    currentImage = new Image();
                    currentImage.src = originalImage.src;
                    elements.canvas.width = originalImage.width * canvasScale;
                    elements.canvas.height = originalImage.height * canvasScale;
                    currentFilter = 'Orijinal';
                    currentCategory = 'normal';
                    texts = [];
                    history = [];
                    toneAdjustments = { brightness: 0, contrast: 0, saturation: 0, hue: 0 };
                    updateToneSliders();
                    redrawCanvas();
                    updateFilterUI(currentFilter, currentCategory);
                    elements.undoBtn.classList.add('hidden');
                }
            };

            const getFilteredStyle = (filterName, intensity) => {
                if (filterName === 'Orijinal' || intensity == 0) return 'none';
                const filterValues = filterPresets[filterName];
                if (!filterValues) return 'none';
                const intensityFactor = intensity / 100;
                const filters = parseFilterString(filterValues);
                let newFilterString = '';
                for (const key in filters) {
                    let value = filters[key];
                    let unit = filterValues.includes(`${key}(${value}%)`) ? '%' : filterValues.includes(`${key}(${value}px)`) ? 'px' : filterValues.includes(`${key}(${value}deg)`) ? 'deg' : '';
                    let adjustedValue = key === 'contrast' || key === 'brightness' || key === 'saturate' ? 1 + (value - 1) * intensityFactor : value * intensityFactor;
                    newFilterString += `${key}(${adjustedValue}${unit}) `;
                }
                return newFilterString.trim();
            };

            const parseFilterString = (filterString) => {
                const filters = {};
                if (filterString === 'none') return filters;
                const filterParts = filterString.match(/(\w+)\(([^)]+)\)/g);
                if (!filterParts) return filters;
                filterParts.forEach(part => {
                    const matches = part.match(/(\w+)\(([^)]+)\)/);
                    if (matches) {
                        let value = matches[2];
                        if (value.endsWith('px') || value.endsWith('%') || value.endsWith('deg')) {
                            value = parseFloat(value);
                        } else {
                            value = parseFloat(value);
                        }
                        filters[matches[1]] = value;
                    }
                });
                return filters;
            };

            const getToneStyle = () => {
                return `brightness(${1 + toneAdjustments.brightness / 100}) contrast(${1 + toneAdjustments.contrast / 100}) saturate(${1 + toneAdjustments.saturation / 100}) hue-rotate(${toneAdjustments.hue}deg)`;
            };

            const redrawCanvas = () => {
                ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
                if (currentImage) {
                    let filterStyle = getFilteredStyle(currentFilter, elements.intensitySlider.value);
                    filterStyle = filterStyle === 'none' ? getToneStyle() : `${filterStyle} ${getToneStyle()}`;
                    ctx.filter = filterStyle;
                    ctx.drawImage(currentImage, 0, 0, elements.canvas.width, elements.canvas.height);
                    ctx.filter = 'none';

                    texts.forEach(t => {
                        ctx.font = `${t.size}px ${t.family}`;
                        ctx.fillStyle = t.color;
                        if (t.shadowBlur > 0) {
                            ctx.shadowColor = t.shadowColor;
                            ctx.shadowBlur = t.shadowBlur;
                            ctx.shadowOffsetX = 2;
                            ctx.shadowOffsetY = 2;
                        } else {
                            ctx.shadowColor = 'transparent';
                            ctx.shadowBlur = 0;
                        }
                        if (t.bgColor !== 'transparent') {
                            ctx.fillStyle = t.bgColor;
                            const metrics = ctx.measureText(t.text);
                            ctx.fillRect(t.x - 5, t.y - t.size + 5, metrics.width + 10, t.size);
                            ctx.fillStyle = t.color;
                        }
                        ctx.fillText(t.text, t.x, t.y);
                    });
                    addWatermark();
                }
            };

            const addWatermark = () => {
                ctx.font = 'bold 12px Inter';
                ctx.fillStyle = 'rgba(226, 232, 240, 0.7)';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'bottom';
                ctx.fillText('axtarget.xyz', elements.canvas.width - 10, elements.canvas.height - 10);
            };

            // Şəkil yükləmə funksiyası
            const handleImageUpload = (file) => {
                if (!file) {
                    showMessage("Şəkil seçilməyib. Zəhmət olmasa bir şəkil seçin.", 3000);
                    return;
                }

                const allowedTypes = ['image/png', 'image/jpeg', 'image/webp', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    showMessage("Yalnız PNG, JPEG, WEBP və ya GIF faylları dəstəklənir.", 3000);
                    return;
                }

                const maxSizeMB = 10;
                if (file.size > maxSizeMB * 1024 * 1024) {
                    showMessage(`Fayl ölçüsü ${maxSizeMB}MB-dan böyük ola bilməz.`, 3000);
                    return;
                }

                elements.loadingSpinner.classList.remove('hidden');
                elements.controls.classList.add('hidden');
                elements.canvasContainer.classList.add('hidden');

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        originalImage = img;
                        const maxCanvasWidth = Math.min(window.innerWidth * 0.9, img.width);
                        const maxCanvasHeight = Math.min(window.innerHeight * 0.7, img.height);
                        canvasScale = Math.min(maxCanvasWidth / img.width, maxCanvasHeight / img.height, 1);
                        elements.canvas.width = img.width * canvasScale;
                        elements.canvas.height = img.height * canvasScale;

                        currentImage = new Image();
                        currentImage.onload = () => {
                            elements.canvasContainer.classList.remove('hidden');
                            elements.controls.classList.remove('hidden');
                            elements.loadingSpinner.classList.add('hidden');
                            currentFilter = 'Orijinal';
                            currentCategory = 'normal';
                            texts = [];
                            history = [];
                            toneAdjustments = { brightness: 0, contrast: 0, saturation: 0, hue: 0 };
                            updateToneSliders();
                            redrawCanvas();
                            generateFilterPreviews();
                            saveState();
                            showMessage("Şəkil uğurla yükləndi!", 2000);
                        };
                        currentImage.onerror = () => {
                            showMessage("Şəkil yüklənmədi. Zəhmət olmasa başqa bir fayl sınayın.", 3000);
                            elements.loadingSpinner.classList.add('hidden');
                        };
                        currentImage.src = e.target.result;
                    };
                    img.onerror = () => {
                        showMessage("Şəkil yüklənmədi. Faylın düzgün olduğundan əmin olun.", 3000);
                        elements.loadingSpinner.classList.add('hidden');
                    };
                    img.src = e.target.result;
                };
                reader.onerror = () => {
                    showMessage("Fayl oxunarkən xəta baş verdi. Zəhmət olmasa yenidən cəhd edin.", 3000);
                    elements.loadingSpinner.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            };

            const generateFilterPreviews = () => {
                if (!originalImage) return;

                const previewSize = 40;
                const previewCanvas = document.createElement('canvas');
                previewCanvas.width = previewSize;
                previewCanvas.height = previewSize;
                const previewCtx = previewCanvas.getContext('2d');

                for (const category in groupedFilters) {
                    const dropdown = elements.filterDropdowns[category];
                    dropdown.innerHTML = '';
                    groupedFilters[category].forEach(filterName => {
                        const item = document.createElement('div');
                        item.classList.add('dropdown-item');
                        item.dataset.filter = filterName;
                        item.dataset.category = category;

                        const img = new Image();
                        img.style.width = `${previewSize}px`;
                        img.style.height = `${previewSize}px`;
                        previewCtx.clearRect(0, 0, previewSize, previewSize);
                        previewCtx.filter = filterPresets[filterName];
                        previewCtx.drawImage(originalImage, 0, 0, previewSize, previewSize);
                        img.src = previewCanvas.toDataURL('image/png', 1.0);
                        item.appendChild(img);

                        const span = document.createElement('span');
                        span.textContent = filterName;
                        item.appendChild(span);

                        item.addEventListener('click', () => {
                            currentFilter = filterName;
                            currentCategory = category;
                            elements.intensitySlider.value = 100;
                            redrawCanvas();
                            updateFilterUI(filterName, category);
                            saveState();
                            for (const cat in elements.filterDropdowns) {
                                elements.filterDropdowns[cat].classList.remove('open');
                            }
                        });

                        dropdown.appendChild(item);
                    });
                }
            };

            const updateFilterUI = (filterName, category) => {
                for (const cat in elements.selectedFilterTexts) {
                    elements.selectedFilterTexts[cat].textContent = cat === category ? filterName : 'Seçin';
                }
                document.querySelectorAll('.dropdown-item').forEach(item => item.classList.remove('active'));
                const activeItem = elements.filterDropdowns[category].querySelector(`[data-filter="${filterName}"]`);
                if (activeItem) activeItem.classList.add('active');
            };

            const updateToneSliders = () => {
                elements.brightnessSlider.value = toneAdjustments.brightness;
                elements.contrastSlider.value = toneAdjustments.contrast;
                elements.saturationSlider.value = toneAdjustments.saturation;
                elements.hueSlider.value = toneAdjustments.hue;
            };

            // Text handling
            elements.textInput.addEventListener('input', () => {
                if (elements.textInput.value && currentTextIndex === -1) {
                    const newText = {
                        text: elements.textInput.value,
                        size: parseInt(elements.textSizeInput.value),
                        family: elements.textFamilySelect.value,
                        color: elements.textColorPicker.value,
                        bgColor: elements.textBgColorPicker.value,
                        shadowColor: elements.textShadowColorPicker.value,
                        shadowBlur: parseInt(elements.textShadowBlur.value),
                        x: elements.canvas.width / 2,
                        y: elements.canvas.height / 2
                    };
                    texts.push(newText);
                    currentTextIndex = texts.length - 1;
                } else if (currentTextIndex !== -1) {
                    texts[currentTextIndex].text = elements.textInput.value;
                }
                redrawCanvas();
            });

            elements.textSizeInput.addEventListener('input', () => {
                if (currentTextIndex !== -1) {
                    texts[currentTextIndex].size = parseInt(elements.textSizeInput.value);
                    redrawCanvas();
                }
            });

            elements.textFamilySelect.addEventListener('change', () => {
                if (currentTextIndex !== -1) {
                    texts[currentTextIndex].family = elements.textFamilySelect.value;
                    redrawCanvas();
                }
            });

            elements.textColorPicker.addEventListener('input', () => {
                elements.textColorDisplay.style.backgroundColor = elements.textColorPicker.value;
                if (currentTextIndex !== -1) {
                    texts[currentTextIndex].color = elements.textColorPicker.value;
                    redrawCanvas();
                }
            });

            elements.textBgColorPicker.addEventListener('input', () => {
                elements.textBgColorDisplay.style.backgroundColor = elements.textBgColorPicker.value;
                if (currentTextIndex !== -1) {
                    texts[currentTextIndex].bgColor = elements.textBgColorPicker.value;
                    redrawCanvas();
                }
            });

            elements.textShadowColorPicker.addEventListener('input', () => {
                elements.textShadowColorDisplay.style.backgroundColor = elements.textShadowColorPicker.value;
                if (currentTextIndex !== -1) {
                    texts[currentTextIndex].shadowColor = elements.textShadowColorPicker.value;
                    redrawCanvas();
                }
            });

            elements.textShadowBlur.addEventListener('input', () => {
                if (currentTextIndex !== -1) {
                    texts[currentTextIndex].shadowBlur = parseInt(elements.textShadowBlur.value);
                    redrawCanvas();
                }
            });

            // Tone adjustments
            elements.brightnessSlider.addEventListener('input', () => {
                toneAdjustments.brightness = parseInt(elements.brightnessSlider.value);
                redrawCanvas();
            });

            elements.contrastSlider.addEventListener('input', () => {
                toneAdjustments.contrast = parseInt(elements.contrastSlider.value);
                redrawCanvas();
            });

            elements.saturationSlider.addEventListener('input', () => {
                toneAdjustments.saturation = parseInt(elements.saturationSlider.value);
                redrawCanvas();
            });

            elements.hueSlider.addEventListener('input', () => {
                toneAdjustments.hue = parseInt(elements.hueSlider.value);
                redrawCanvas();
            });

            // Tab switching
            for (const tab in elements.tabButtons) {
                elements.tabButtons[tab].addEventListener('click', () => {
                    for (const t in elements.tabButtons) {
                        elements.tabButtons[t].classList.remove('active');
                        elements.toolPanels[t].classList.remove('active');
                        elements.toolPanels[t].classList.add('hidden');
                    }
                    elements.tabButtons[tab].classList.add('active');
                    elements.toolPanels[tab].classList.add('active');
                    elements.toolPanels[tab].classList.remove('hidden');
                    currentTool = 'none';
                    elements.manualControls.classList.add('hidden');
                    elements.colorPickerContainer.classList.add('hidden');
                    elements.canvas.style.cursor = 'crosshair';
                    document.querySelectorAll('.tool-option-btn').forEach(btn => btn.classList.remove('active'));
                    if (tab === 'text' && currentTextIndex !== -1) {
                        elements.textInput.value = texts[currentTextIndex].text;
                        elements.textSizeInput.value = texts[currentTextIndex].size;
                        elements.textFamilySelect.value = texts[currentTextIndex].family;
                        elements.textColorPicker.value = texts[currentTextIndex].color;
                        elements.textColorDisplay.style.backgroundColor = texts[currentTextIndex].color;
                        elements.textBgColorPicker.value = texts[currentTextIndex].bgColor;
                        elements.textBgColorDisplay.style.backgroundColor = texts[currentTextIndex].bgColor;
                        elements.textShadowColorPicker.value = texts[currentTextIndex].shadowColor;
                        elements.textShadowColorDisplay.style.backgroundColor = texts[currentTextIndex].shadowColor;
                        elements.textShadowBlur.value = texts[currentTextIndex].shadowBlur;
                    }
                    if (tab === 'tone') updateToneSliders();
                });
            }

            // Image upload event
            elements.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                handleImageUpload(file);
                e.target.value = ''; // Reset input
            });

            // Drag and drop
            elements.canvasContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.canvasContainer.style.border = '2px dashed #3b82f6';
            });

            elements.canvasContainer.addEventListener('dragleave', () => {
                elements.canvasContainer.style.border = 'none';
            });

            elements.canvasContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.canvasContainer.style.border = 'none';
                const file = e.dataTransfer.files[0];
                handleImageUpload(file);
            });

            // Filter dropdowns
            for (const category in elements.selectHeaders) {
                elements.selectHeaders[category].addEventListener('click', () => {
                    const dropdown = elements.filterDropdowns[category];
                    const isOpen = dropdown.classList.contains('open');
                    for (const cat in elements.filterDropdowns) {
                        elements.filterDropdowns[cat].classList.remove('open');
                    }
                    if (!isOpen) dropdown.classList.add('open');
                });
            }

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-select')) {
                    for (const cat in elements.filterDropdowns) {
                        elements.filterDropdowns[cat].classList.remove('open');
                    }
                }
            });

            // Download
            elements.downloadBtn.addEventListener('click', () => {
                if (!currentImage) {
                    showMessage("Əvvəlcə şəkil yükləyin.", 3000);
                    return;
                }
                const resolution = document.querySelector('input[name="resolution"]:checked').value;
                let width = originalImage.width;
                let height = originalImage.height;
                if (resolution === '4k') {
                    width = 3840;
                    height = width * (originalImage.height / originalImage.width);
                } else if (resolution === '8k') {
                    width = 7680;
                    height = width * (originalImage.height / originalImage.width);
                }
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = width;
                tempCanvas.height = height;
                const tempCtx = tempCanvas.getContext('2d');
                let filterStyle = getFilteredStyle(currentFilter, elements.intensitySlider.value);
                filterStyle = filterStyle === 'none' ? getToneStyle() : `${filterStyle} ${getToneStyle()}`;
                tempCtx.filter = filterStyle;
                tempCtx.drawImage(originalImage, 0, 0, width, height);
                tempCtx.filter = 'none';
                const scaleX = width / elements.canvas.width;
                const scaleY = height / elements.canvas.height;
                texts.forEach(t => {
                    tempCtx.font = `${t.size * scaleY}px ${t.family}`;
                    tempCtx.fillStyle = t.color;
                    if (t.shadowBlur > 0) {
                        tempCtx.shadowColor = t.shadowColor;
                        tempCtx.shadowBlur = t.shadowBlur;
                        tempCtx.shadowOffsetX = 2;
                        tempCtx.shadowOffsetY = 2;
                    } else {
                        tempCtx.shadowColor = 'transparent';
                        tempCtx.shadowBlur = 0;
                    }
                    if (t.bgColor !== 'transparent') {
                        tempCtx.fillStyle = t.bgColor;
                        const metrics = tempCtx.measureText(t.text);
                        tempCtx.fillRect(t.x * scaleX - 5, t.y * scaleY - t.size * scaleY + 5, metrics.width + 10, t.size * scaleY);
                        tempCtx.fillStyle = t.color;
                    }
                    tempCtx.fillText(t.text, t.x * scaleX, t.y * scaleY);
                });
                tempCtx.font = 'bold 12px Inter';
                tempCtx.fillStyle = 'rgba(226, 232, 240, 0.7)';
                tempCtx.textAlign = 'right';
                tempCtx.textBaseline = 'bottom';
                tempCtx.fillText('axtarget.xyz', width - 10, height - 10);
                const link = document.createElement('a');
                link.download = `axtarget-${Date.now()}.png`;
                link.href = tempCanvas.toDataURL('image/png', 1.0);
                link.click();
            });

            // Text dragging and resizing
            const getCanvasCoordinates = (e) => {
                const rect = elements.canvas.getBoundingClientRect();
                let x, y;
                if (e.type.includes('touch')) {
                    x = (e.touches[0].clientX - rect.left) * (elements.canvas.width / rect.width);
                    y = (e.touches[0].clientY - rect.top) * (elements.canvas.height / rect.height);
                } else {
                    x = (e.clientX - rect.left) * (elements.canvas.width / rect.width);
                    y = (e.clientY - rect.top) * (elements.canvas.height / rect.height);
                }
                return { x, y };
            };

            elements.canvas.addEventListener('mousedown', (e) => handleStart(e));
            elements.canvas.addEventListener('mousemove', (e) => handleMove(e));
            elements.canvas.addEventListener('mouseup', () => handleEnd());
            elements.canvas.addEventListener('touchstart', (e) => handleStart(e));
            elements.canvas.addEventListener('touchmove', (e) => handleMove(e));
            elements.canvas.addEventListener('touchend', () => handleEnd());

            const handleStart = (e) => {
                e.preventDefault();
                const { x, y } = getCanvasCoordinates(e);
                
                if (currentTool === 'manualRemove') {
                    isDrawing = true;
                    lastX = x;
                    lastY = y;
                    drawOnMask(x, y, true);
                    return;
                }
                
                if (elements.toolPanels.text.classList.contains('active')) {
                    texts.forEach((text, index) => {
                        ctx.font = `${text.size}px ${text.family}`;
                        const metrics = ctx.measureText(text.text);
                        const textWidth = metrics.width;
                        const textHeight = text.size;
                        if (x > text.x + textWidth - 10 && x < text.x + textWidth + 10 && y > text.y - 10 && y < text.y + 10) {
                            isResizingText = true;
                            currentTextIndex = index;
                            startDragX = x;
                            startDragY = y;
                        } else if (x >= text.x && x <= text.x + textWidth && y >= text.y - textHeight && y <= text.y) {
                            isDraggingText = true;
                            currentTextIndex = index;
                            startDragX = x - text.x;
                            startDragY = y - text.y;
                            elements.textInput.value = text.text;
                            elements.textSizeInput.value = text.size;
                            elements.textFamilySelect.value = text.family;
                            elements.textColorPicker.value = text.color;
                            elements.textColorDisplay.style.backgroundColor = text.color;
                            elements.textBgColorPicker.value = text.bgColor;
                            elements.textBgColorDisplay.style.backgroundColor = text.bgColor;
                            elements.textShadowColorPicker.value = text.shadowColor;
                            elements.textShadowColorDisplay.style.backgroundColor = text.shadowColor;
                            elements.textShadowBlur.value = text.shadowBlur;
                        }
                    });
                }
            };

            const handleMove = (e) => {
                e.preventDefault();
                const { x, y } = getCanvasCoordinates(e);
                
                if (isDrawing && currentTool === 'manualRemove') {
                    drawOnMask(x, y, false);
                    lastX = x;
                    lastY = y;
                    return;
                }
                
                if (isDraggingText) {
                    texts[currentTextIndex].x = x - startDragX;
                    texts[currentTextIndex].y = y - startDragY;
                    redrawCanvas();
                } else if (isResizingText) {
                    const dx = x - startDragX;
                    texts[currentTextIndex].size += dx / 2;
                    if (texts[currentTextIndex].size < 10) texts[currentTextIndex].size = 10;
                    elements.textSizeInput.value = texts[currentTextIndex].size;
                    startDragX = x;
                    startDragY = y;
                    redrawCanvas();
                }
            };

            const handleEnd = () => {
                if (isDrawing && currentTool === 'manualRemove') {
                    applyMask();
                    saveState();
                } else if (isDraggingText || isResizingText) {
                    saveState();
                }
                isDrawing = false;
                isDraggingText = false;
                isResizingText = false;
                currentTextIndex = -1;
            };

            // Background removal functions
            const initMaskCanvas = () => {
                if (!maskCanvas) {
                    maskCanvas = document.createElement('canvas');
                    maskCanvas.width = elements.canvas.width;
                    maskCanvas.height = elements.canvas.height;
                    maskCtx = maskCanvas.getContext('2d');
                    maskCtx.fillStyle = 'white';
                    maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
                }
            };

            const drawOnMask = (x, y, isStart) => {
                if (!maskCanvas) initMaskCanvas();
                
                maskCtx.globalCompositeOperation = 'destination-out';
                maskCtx.lineWidth = parseInt(elements.brushSizeSlider.value);
                maskCtx.lineCap = 'round';
                maskCtx.lineJoin = 'round';
                
                if (isStart) {
                    maskCtx.beginPath();
                    maskCtx.arc(x, y, maskCtx.lineWidth / 2, 0, Math.PI * 2);
                    maskCtx.fill();
                    maskCtx.beginPath();
                    maskCtx.moveTo(x, y);
                } else {
                    maskCtx.lineTo(x, y);
                    maskCtx.stroke();
                }
                
                // Show the mask on canvas
                ctx.globalCompositeOperation = 'source-over';
                ctx.drawImage(currentImage, 0, 0, elements.canvas.width, elements.canvas.height);
                ctx.globalCompositeOperation = 'destination-in';
                ctx.drawImage(maskCanvas, 0, 0);
                ctx.globalCompositeOperation = 'source-over';
                
                // Draw texts back
                texts.forEach(t => {
                    ctx.font = `${t.size}px ${t.family}`;
                    ctx.fillStyle = t.color;
                    if (t.shadowBlur > 0) {
                        ctx.shadowColor = t.shadowColor;
                        ctx.shadowBlur = t.shadowBlur;
                        ctx.shadowOffsetX = 2;
                        ctx.shadowOffsetY = 2;
                    } else {
                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;
                    }
                    if (t.bgColor !== 'transparent') {
                        ctx.fillStyle = t.bgColor;
                        const metrics = ctx.measureText(t.text);
                        ctx.fillRect(t.x - 5, t.y - t.size + 5, metrics.width + 10, t.size);
                        ctx.fillStyle = t.color;
                    }
                    ctx.fillText(t.text, t.x, t.y);
                });
            };

            const applyMask = () => {
                if (!maskCanvas) return;
                
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = elements.canvas.width;
                tempCanvas.height = elements.canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                // Apply mask to create transparent background
                tempCtx.drawImage(currentImage, 0, 0);
                tempCtx.globalCompositeOperation = 'destination-in';
                tempCtx.drawImage(maskCanvas, 0, 0);
                tempCtx.globalCompositeOperation = 'source-over';
                
                // Update current image
                currentImage = new Image();
                currentImage.src = tempCanvas.toDataURL('image/png');
                currentImage.onload = () => {
                    redrawCanvas();
                };
            };

            const removeBackgroundByColor = () => {
                const colorHex = elements.colorToRemove.value;
                const tolerance = parseInt(elements.colorTolerance.value);
                
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = elements.canvas.width;
                tempCanvas.height = elements.canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(currentImage, 0, 0);
                
                const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const data = imageData.data;
                
                // Convert hex to RGB
                const r = parseInt(colorHex.substr(1, 2), 16);
                const g = parseInt(colorHex.substr(3, 2), 16);
                const b = parseInt(colorHex.substr(5, 2), 16);
                
                for (let i = 0; i < data.length; i += 4) {
                    const dr = Math.abs(data[i] - r);
                    const dg = Math.abs(data[i + 1] - g);
                    const db = Math.abs(data[i + 2] - b);
                    
                    if (dr <= tolerance && dg <= tolerance && db <= tolerance) {
                        data[i + 3] = 0; // Set alpha to 0 (transparent)
                    }
                }
                
                tempCtx.putImageData(imageData, 0, 0);
                
                // Update current image
                currentImage = new Image();
                currentImage.src = tempCanvas.toDataURL('image/png');
                currentImage.onload = () => {
                    redrawCanvas();
                    saveState();
                    showMessage("Fon rəngə görə silindi!", 2000);
                };
            };

            // Background removal event handlers
            elements.autoRemoveBtn.addEventListener('click', () => {
                showMessage("Avtomatik fon silmə funksiyası hazırlanır...", 3000);
            });

            elements.colorRemoveBtn.addEventListener('click', () => {
                currentTool = 'colorRemove';
                elements.colorPickerContainer.classList.remove('hidden');
                elements.manualControls.classList.add('hidden');
                document.querySelectorAll('.tool-option-btn').forEach(btn => btn.classList.remove('active'));
                elements.colorRemoveBtn.classList.add('active');
            });

            elements.manualRemoveBtn.addEventListener('click', () => {
                currentTool = 'manualRemove';
                elements.manualControls.classList.remove('hidden');
                elements.colorPickerContainer.classList.add('hidden');
                elements.canvas.style.cursor = 'crosshair';
                document.querySelectorAll('.tool-option-btn').forEach(btn => btn.classList.remove('active'));
                elements.manualRemoveBtn.classList.add('active');
                initMaskCanvas();
            });

            elements.colorToRemove.addEventListener('input', () => {
                elements.colorPreview.style.backgroundColor = elements.colorToRemove.value;
            });

            elements.colorToRemove.addEventListener('change', () => {
                removeBackgroundByColor();
            });

            elements.colorTolerance.addEventListener('input', () => {
                removeBackgroundByColor();
            });

            // Undo button
            elements.undoBtn.addEventListener('click', undoLastAction);

            // Initialize
            elements.resolutionInfo.classList.add('hidden');
            showMessage("Səhifə hazırdır! Şəkil yükləyə bilərsiniz.", 2000);
        })();
    </script>
</body>
</html>
