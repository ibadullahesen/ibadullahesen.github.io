<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6197631175303658"
     crossorigin="anonymous"></script>
    
    <title>Yüksək Keyfiyyətli QR Kod Generatoru</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Styling CDN for modern QR codes -->
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.6.0-rc.1/lib/qr-code-styling.js"></script>
    <!-- Cropper.js for image cropping -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
        }
        /* Style for the QR code container */
        #qrcode canvas, #qrcode img {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        /* Cropper CSS override for better visibility in dark theme */
        .cropper-view-box {
            outline-color: #10B981 !important; /* Green 500 */
        }
        /* Ensure the image in cropper is visible */
        #image-to-crop {
            display: block;
            max-width: 100%;
        }
        /* Style for the active color dot */
        .color-dot.dots-active {
            border-color: #FFFFFF; /* White border for active selection */
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-4">

    <div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-lg text-center">
        <h1 class="text-3xl font-extrabold text-white mb-2">QR Kod Generatoru <span class="text-green-500">PRO</span></h1>
        <p class="text-gray-400 mb-6">Link daxil edin və loqo/fon şəkillərini fərdiləşdirin.</p>

        <!-- User ID display (Placeholder for Auth Status) -->
        <div class="mb-4 text-xs text-gray-500">
            <span id="user-id"></span>
        </div>

        <!-- URL Input -->
        <div class="mb-4">
            <input type="url" id="url-input" placeholder="Linkinizi daxil edin (məs: https://google.com)" class="w-full px-4 py-3 border border-gray-600 bg-gray-700 text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 transition-all duration-200" required>
        </div>

        <!-- Rəng Seçimi -->
        <div class="mb-6 p-4 bg-gray-700 rounded-xl">
            <h3 class="text-white font-semibold mb-3">QR Kod Nöqtələrinin Rəngi</h3>
            <div id="dots-color-selector" class="flex justify-around items-center flex-wrap gap-3">
                <button class="color-dot w-8 h-8 rounded-full border-4 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-700 transition-all duration-150 dots-active" style="background-color: #000000;" data-color="#000000" title="Qara"></button>
                <button class="color-dot w-8 h-8 rounded-full border-4 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-700 transition-all duration-150" style="background-color: #EF4444;" data-color="#EF4444" title="Qırmızı"></button>
                <button class="color-dot w-8 h-8 rounded-full border-4 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-700 transition-all duration-150" style="background-color: #3B82F6;" data-color="#3B82F6" title="Mavi"></button>
                <button class="color-dot w-8 h-8 rounded-full border-4 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-700 transition-all duration-150" style="background-color: #10B981;" data-color="#10B981" title="Yaşıl"></button>
                <button class="color-dot w-8 h-8 rounded-full border-4 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-700 transition-all duration-150" style="background-color: #F97316;" data-color="#F97316" title="Narıncı"></button>
                <button class="color-dot w-8 h-8 rounded-full border-4 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-700 transition-all duration-150" style="background-color: #EC4899;" data-color="#EC4899" title="Çəhrayı"></button>
            </div>
        </div>

        <!-- Loqo Input & Cropping Button -->
        <div class="flex flex-col md:flex-row gap-3 mb-4 p-3 bg-gray-700 rounded-xl">
            <input type="file" id="logo-input" accept="image/*" class="hidden" data-target="logo" />
            <button id="select-logo-btn" class="flex-1 bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-gray-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-500">
                Mərkəz Loqosu Seç <span id="logo-status" class="text-red-400 text-sm">(Seçilməyib)</span>
            </button>
            <button id="clear-logo-btn" class="bg-red-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-600 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-500">
                Sil
            </button>
        </div>
        
        <!-- Fon Şəkli Input & Cropping Button -->
        <div class="flex flex-col md:flex-row gap-3 mb-6 p-3 bg-gray-700 rounded-xl">
            <input type="file" id="background-input" accept="image/*" class="hidden" data-target="background" />
            <button id="select-background-btn" class="flex-1 bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-gray-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                Fon Şəkli Seç <span id="background-status" class="text-red-400 text-sm">(Seçilməyib)</span>
            </button>
            <button id="clear-background-btn" class="bg-red-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-600 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-500">
                Sil
            </button>
        </div>

        <!-- Generate Button -->
        <button id="generate-btn" class="w-full bg-green-500 text-white font-extrabold text-lg py-3 px-4 rounded-xl hover:bg-green-600 transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-800 shadow-lg shadow-green-700/50">
            QR Kodu Yarat
        </button>

        <div id="message-box" class="text-red-400 mt-4 hidden"></div>

        <div id="qrcode-container-wrapper" class="mt-8 flex flex-col items-center">
            <!-- Changed background to white for the QR code container -->
            <div id="qrcode" class="p-4 bg-white rounded-2xl shadow-inner hidden"></div>
        </div>

        <!-- Download Button -->
        <button id="download-btn" class="w-full bg-green-500 text-white font-semibold py-3 px-4 rounded-xl mt-6 hidden hover:bg-green-600 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-800 shadow-lg">
            QR Kodu Yüklə (PNG)
        </button>
    </div>

    <!-- Cropping Modal (Full-screen overlay) -->
    <div id="crop-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-2xl">
            <h2 id="modal-title" class="text-xl font-bold text-white mb-4">Şəkli Kəs</h2>
            
            <div class="w-full h-80 overflow-hidden mb-4 border-2 border-green-500 rounded-lg">
                <img id="image-to-crop" src="" alt="Şəkil Kəsmə" class="max-w-full h-auto">
            </div>
            
            <p id="crop-guidance" class="text-sm text-gray-400 mb-4"></p>

            <div class="flex justify-end gap-3">
                <button id="cancel-crop-btn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-500 transition-all duration-200">
                    Ləğv Et
                </button>
                <button id="confirm-crop-btn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-all duration-200">
                    Kəsməni Təsdiqlə
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Global variables for Firebase configuration.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI Elements
        const urlInput = document.getElementById('url-input');
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const qrcodeContainer = document.getElementById('qrcode');
        const userIdPlaceholder = document.getElementById('user-id');
        const messageBox = document.getElementById('message-box');

        // Color Selection Elements
        const colorSelectorContainer = document.getElementById('dots-color-selector');
        const colorDots = colorSelectorContainer.querySelectorAll('.color-dot');
        let selectedDotsColor = "#000000"; // Default to Black

        // Logo Elements
        const logoInput = document.getElementById('logo-input');
        const selectLogoBtn = document.getElementById('select-logo-btn');
        const logoStatus = document.getElementById('logo-status');
        const clearLogoBtn = document.getElementById('clear-logo-btn');
        
        // Background Elements
        const backgroundInput = document.getElementById('background-input');
        const selectBackgroundBtn = document.getElementById('select-background-btn');
        const backgroundStatus = document.getElementById('background-status');
        const clearBackgroundBtn = document.getElementById('clear-background-btn');


        // Cropping Modal Elements
        const cropModal = document.getElementById('crop-modal');
        const modalTitle = document.getElementById('modal-title');
        const imageToCrop = document.getElementById('image-to-crop');
        const confirmCropBtn = document.getElementById('confirm-crop-btn');
        const cancelCropBtn = document.getElementById('cancel-crop-btn');
        const cropGuidance = document.getElementById('crop-guidance');

        let qrCode = null;
        let cropper = null;
        let croppedImageBase64 = null; // Stores Logo image Base64
        let croppedBackgroundImageBase64 = null; // Stores Background image Base64
        let currentCropperTarget = 'logo'; // 'logo' or 'background'

        // Function to display messages (instead of alert)
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = isError 
                ? 'text-red-400 mt-4' 
                : 'text-green-400 mt-4';
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // Initialize Auth Status Display (Simplified since no Firestore is used)
        if (initialAuthToken) { 
            userIdPlaceholder.textContent = `İstifadəçi statusu: Qurulub`;
        } else {
            userIdPlaceholder.textContent = `İstifadəçi statusu: Anonim`;
        }
        
        // --- Color Selection Logic ---

        // Function to set the active color style
        function setActiveDot(selectedButton) {
            colorDots.forEach(dot => {
                dot.classList.remove('dots-active');
            });
            selectedButton.classList.add('dots-active');
            selectedDotsColor = selectedButton.dataset.color;
        }

        // Attach event listeners to color buttons
        colorDots.forEach(dot => {
            dot.addEventListener('click', () => {
                setActiveDot(dot);
                showMessage(`Nöqtə rəngi dəyişdirildi: ${dot.title}`, false);
            });
        });
        
        // --- Cropping Modal and File Input Logic ---
        function handleFileInput(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            currentCropperTarget = inputElement.dataset.target;

            const reader = new FileReader();
            reader.onload = (event) => {
                imageToCrop.src = event.target.result;
                cropModal.classList.remove('hidden');

                if (cropper) {
                    cropper.destroy();
                }
                
                let aspectRatio = 1; // Default square for logo
                let title = 'Loqo Şəkilini Kəs (Kvadrat)';
                let guidance = 'Loqo üçün şəkli kvadrat (1:1) nisbətində kəsin.';

                if (currentCropperTarget === 'background') {
                    // QR kodun fonu üçün daha sərbəst nisbət (daha böyük sahəyə uyğunlaşdırılır)
                    aspectRatio = NaN; 
                    title = 'Fon Şəkilini Kəs';
                    guidance = 'Fon üçün şəkli sərbəst formada kəsin və ya sadəcə yerini dəyişin.';
                }
                
                modalTitle.textContent = title;
                cropGuidance.textContent = guidance;

                // Initialize Cropper
                cropper = new Cropper(imageToCrop, {
                    aspectRatio: aspectRatio,
                    viewMode: 1,
                    background: false,
                    movable: true,
                    scalable: true,
                    zoomable: true,
                    autoCropArea: 0.8,
                });
            };
            reader.readAsDataURL(file);
        }

        selectLogoBtn.addEventListener('click', () => logoInput.click());
        selectBackgroundBtn.addEventListener('click', () => backgroundInput.click());

        logoInput.addEventListener('change', (e) => handleFileInput(e.target));
        backgroundInput.addEventListener('change', (e) => handleFileInput(e.target));


        clearLogoBtn.addEventListener('click', () => {
            croppedImageBase64 = null;
            logoInput.value = '';
            logoStatus.textContent = '(Seçilməyib)';
            logoStatus.classList.remove('text-green-400');
            logoStatus.classList.add('text-red-400');
            showMessage('Mərkəz loqosu silindi.', false);
        });
        
        clearBackgroundBtn.addEventListener('click', () => {
            croppedBackgroundImageBase64 = null;
            backgroundInput.value = '';
            backgroundStatus.textContent = '(Seçilməyib)';
            backgroundStatus.classList.remove('text-green-400');
            backgroundStatus.classList.add('text-red-400');
            showMessage('Fon şəkli silindi.', false);
        });


        confirmCropBtn.addEventListener('click', () => {
            if (cropper) {
                // Get the cropped image data as a high-quality PNG (512x512 for logo, 1000x1000 for background)
                const qualitySize = currentCropperTarget === 'logo' 
                    ? { width: 512, height: 512 } 
                    : { width: 1000, height: 1000 };
                    
                const base64Data = cropper.getCroppedCanvas({
                    ...qualitySize,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high',
                }).toDataURL('image/png', 1.0); // 1.0 is max quality

                if (currentCropperTarget === 'logo') {
                    croppedImageBase64 = base64Data;
                    logoStatus.textContent = '(Seçildi)';
                    logoStatus.classList.remove('text-red-400');
                    logoStatus.classList.add('text-green-400');
                    showMessage('Loqo kəsildi və təyin edildi.', false);
                } else if (currentCropperTarget === 'background') {
                    croppedBackgroundImageBase64 = base64Data;
                    backgroundStatus.textContent = '(Seçildi)';
                    backgroundStatus.classList.remove('text-red-400');
                    backgroundStatus.classList.add('text-green-400');
                    showMessage('Fon şəkli kəsildi və təyin edildi.', false);
                }


                cropper.destroy();
                cropModal.classList.add('hidden');
            }
        });

        cancelCropBtn.addEventListener('click', () => {
            if (cropper) {
                cropper.destroy();
            }
            cropModal.classList.add('hidden');
            // Clear the specific file input that was active
            if (currentCropperTarget === 'logo') {
                 logoInput.value = ''; 
            } else if (currentCropperTarget === 'background') {
                 backgroundInput.value = ''; 
            }
        });
        
        // --- QR Code Generation Logic ---
        generateBtn.addEventListener('click', () => {
            const url = urlInput.value.trim();
            if (!url) {
                showMessage('Zəhmət olmasa, QR kod yaratmaq üçün bir link daxil edin.', true);
                return;
            }

            // Clear any previous QR code
            qrcodeContainer.innerHTML = '';
            qrcodeContainer.classList.add('hidden');
            downloadBtn.classList.add('hidden');

            try {
                const qrCodeOptions = {
                    width: 400,
                    height: 400,
                    data: url,
                    margin: 5,
                    qrOptions: {
                        typeNumber: 0, 
                        mode: 'Byte', 
                        errorCorrectionLevel: 'H' // Yüksək səviyyəli səhv korreksiyası
                    },
                    dotsOptions: {
                        color: selectedDotsColor, // Seçilmiş rəng istifadə olunur
                        type: "rounded"
                    },
                    cornersSquareOptions: {
                        color: "#16A34A", // Standart yaşıl
                        type: "extra-rounded"
                    },
                    cornersDotOptions: {
                        color: "#075985" // Standart tünd mavi
                    },
                    imageOptions: {
                        crossOrigin: "anonymous",
                        margin: 10,
                        hideBackgroundDots: true,
                    },
                    backgroundOptions: {
                        color: "#FFFFFF", 
                    },
                };

                // 1. Fon Şəkli (Background) əlavə et
                if (croppedBackgroundImageBase64) {
                    qrCodeOptions.backgroundOptions = {
                        color: "#FFFFFF",
                        image: croppedBackgroundImageBase64,
                        imageOptions: {
                            crossOrigin: "anonymous"
                        }
                    };
                } else {
                    // Fon şəkli yoxdursa, arxa planı standart ağ edirik
                    qrCodeOptions.backgroundOptions = { color: "#FFFFFF" };
                }

                // 2. Mərkəz Loqosu (Foreground) əlavə et
                if (croppedImageBase64) {
                    qrCodeOptions.image = croppedImageBase64;
                }
                
                qrCode = new QRCodeStyling(qrCodeOptions);
                
                qrCode.append(qrcodeContainer);

                // Show the container and download button
                qrcodeContainer.classList.remove('hidden');
                downloadBtn.classList.remove('hidden');
                showMessage('QR Kod uğurla yaradıldı!', false);

            } catch (error) {
                console.error('QR kod yaratmaq xətası:', error);
                showMessage('QR kod yaradıla bilmədi. Zəhmət olmasa, linki yoxlayın.', true);
            }
        });

        downloadBtn.addEventListener('click', () => {
            if (qrCode) {
                // Download as PNG with higher resolution (e.g., 1000x1000) for high quality
                qrCode.download({ 
                    name: "yuksək_keyfiyyətli_qrcode", 
                    extension: "png",
                    width: 1000,
                    height: 1000 
                });
                showMessage('QR Kod yüklənməyə başladı.', false);
            } else {
                showMessage('QR kod yüklənməsi xətası: Əvvəlcə QR kodu yaratmalısınız.', true);
            }
        });

    </script>
</body>
</html>
